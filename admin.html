<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel - Form Monitoring LTT & LTP</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .admin-header {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
    }

    .admin-header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .admin-header p {
      opacity: 0.9;
      font-size: 16px;
    }

    .admin-info {
      position: absolute;
      top: 20px;
      right: 30px;
      text-align: right;
      font-size: 14px;
    }

    .logout-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
      transition: background 0.3s ease;
    }

    .logout-btn:hover {
      background: #c0392b;
    }

    .admin-content {
      padding: 40px;
    }

    .admin-tabs {
      display: flex;
      margin-bottom: 30px;
      background: #f8f9fa;
      border-radius: 10px;
      padding: 5px;
    }

    .tab-btn {
      flex: 1;
      padding: 15px 20px;
      background: transparent;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      color: #666;
    }

    .tab-btn.active {
      background: #3498db;
      color: white;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .card {
      background: white;
      border: 1px solid #e1e8ed;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .card h3 {
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 20px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #34495e;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    .btn-success {
      background: #2ecc71;
      color: white;
    }

    .btn-success:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    .btn-warning {
      background: #f39c12;
      color: white;
    }

    .btn-warning:hover {
      background: #e67e22;
      transform: translateY(-2px);
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
    }

    .user-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .user-table th,
    .user-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e1e8ed;
    }

    .user-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #2c3e50;
    }

    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-online {
      background: #2ecc71;
    }

    .status-offline {
      background: #95a5a6;
    }

    .month-lock-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .lock-status {
      display: flex;
      align-items: center;
      font-weight: 600;
    }

    .lock-icon {
      font-size: 20px;
      margin-right: 10px;
    }

    .locked {
      color: #e74c3c;
    }

    .unlocked {
      color: #2ecc71;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      z-index: 10000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      background: #2ecc71;
    }

    .toast.error {
      background: #e74c3c;
    }

    .toast.warning {
      background: #f39c12;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      padding: 25px;
      border-radius: 12px;
      text-align: center;
    }

    .stat-card.users {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
    }

    .stat-card.sessions {
      background: linear-gradient(135deg, #f39c12, #e67e22);
    }

    .stat-card.submissions {
      background: linear-gradient(135deg, #9b59b6, #8e44ad);
    }

    .stat-number {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Auth protection overlay */
    .auth-protection {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      z-index: 10000;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .auth-loading {
      text-align: center;
      color: #2c3e50;
    }

    /* Success/Error messages */
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-weight: 500;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert-warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    @media (max-width: 768px) {
      .admin-content {
        padding: 20px;
      }
      
      .admin-tabs {
        flex-direction: column;
      }
      
      .tab-btn {
        margin-bottom: 5px;
      }
      
      .settings-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <!-- Auth Protection Overlay -->
  <div id="authProtection" class="auth-protection">
    <div class="auth-loading">
      <div class="spinner"></div>
      <h3>Memverifikasi akses admin...</h3>
      <p>Mohon tunggu sebentar</p>
    </div>
  </div>

  <div class="admin-container">
    <div class="admin-header">
      <div class="admin-info">
        <div>Admin: <span id="adminName">***</span></div>
        <div>Login: <span id="loginTime">***</span></div>
        <div>Sisa: <span id="timeRemaining">***</span></div>
        <button class="logout-btn" onclick="logout()">üö™ Logout</button>
      </div>
      
      <h1>üõ†Ô∏è Admin Panel</h1>
      <p>Sistem Administrasi Form Monitoring LTT & LTP</p>
    </div>

    <div class="admin-content">
      <!-- Statistics -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalUsers">0</div>
          <div class="stat-label">Total User</div>
        </div>
        <div class="stat-card users">
          <div class="stat-number" id="activeUsers">0</div>
          <div class="stat-label">User Online</div>
        </div>
        <div class="stat-card sessions">
          <div class="stat-number" id="activeSessions">0</div>
          <div class="stat-label">Sesi Aktif</div>
        </div>
        <div class="stat-card submissions">
          <div class="stat-number" id="totalSubmissions">0</div>
          <div class="stat-label">Total Submission</div>
        </div>
      </div>

      <!-- Admin Tabs -->
      <div class="admin-tabs">
        <button class="tab-btn active" onclick="switchTab('month-control')">üìÖ Kontrol Bulan</button>
        <button class="tab-btn" onclick="switchTab('user-sessions')">üë• Manajemen User</button>
        <button class="tab-btn" onclick="switchTab('system-settings')">‚öôÔ∏è Pengaturan Sistem</button>
        <button class="tab-btn" onclick="switchTab('data-monitoring')">üìä Monitoring Data</button>
      </div>

      <!-- Tab Content: Month Control -->
      <div id="month-control" class="tab-content active">
        <div class="card">
          <h3>üîí Kontrol Kunci Bulan Timestamp</h3>
          
          <!-- Alert Messages -->
          <div id="alertContainer"></div>
          
          <!-- Current Status -->
          <div class="month-lock-status">
            <div class="lock-status" id="lockStatusDisplay">
              <span class="lock-icon">üîí</span>
              <span>Status: Loading...</span>
            </div>
            <button class="btn btn-warning" onclick="toggleMonthLock()">
              <span id="lockToggleText">Toggle Lock</span>
            </button>
          </div>

          <div class="settings-grid">
            <div>
              <div class="form-group">
                <label>Bulan yang Dikunci</label>
                <select id="lockedMonth">
                  <option value="">Tidak ada yang dikunci</option>
                  <option value="1">Januari</option>
                  <option value="2">Februari</option>
                  <option value="3">Maret</option>
                  <option value="4">April</option>
                  <option value="5">Mei</option>
                  <option value="6">Juni</option>
                  <option value="7">Juli</option>
                  <option value="8">Agustus</option>
                  <option value="9">September</option>
                  <option value="10">Oktober</option>
                  <option value="11">November</option>
                  <option value="12">Desember</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>Tahun</label>
                <input type="number" id="lockedYear" value="2025" min="2020" max="2030">
              </div>
              
              <button class="btn btn-primary" onclick="setMonthLock()">üíæ Simpan Pengaturan</button>
            </div>

            <div>
              <div class="form-group">
                <label>Pesan untuk User (Optional)</label>
                <textarea id="lockMessage" rows="4" placeholder="Contoh: Input data untuk bulan Januari 2025 telah ditutup. Silakan hubungi admin jika ada keperluan mendesak."></textarea>
              </div>
              
              <button class="btn btn-success" onclick="broadcastMessage()">üì¢ Kirim Pesan ke Semua User</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab Content: User Sessions -->
      <div id="user-sessions" class="tab-content">
        <div class="card">
          <h3>üë• Manajemen User & Session</h3>
          
          <div style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="refreshUserData()">üîÑ Refresh Data</button>
            <button class="btn btn-danger" onclick="forceLogoutAll()">üö™ Logout Semua User</button>
            <button class="btn btn-warning" onclick="extendAllSessions()">‚è∞ Perpanjang Semua Sesi</button>
          </div>

          <div class="loading" id="userLoading">
            <div class="spinner"></div>
            <p>Memuat data user...</p>
          </div>

          <table class="user-table" id="userTable" style="display: none;">
            <thead>
              <tr>
                <th>Status</th>
                <th>Kode User</th>
                <th>Nama Penyuluh</th>
                <th>Waktu Login</th>
                <th>Sisa Sesi</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="userTableBody">
            </tbody>
          </table>
        </div>
      </div>

      <!-- Tab Content: System Settings -->
      <div id="system-settings" class="tab-content">
        <div class="card">
          <h3>‚öôÔ∏è Pengaturan Sistem</h3>
          
          <div class="settings-grid">
            <div>
              <h4>Session Settings</h4>
              <div class="form-group">
                <label>Durasi Session (jam)</label>
                <input type="number" id="sessionDuration" value="8" min="1" max="24">
              </div>
              
              <div class="form-group">
                <label>Warning Time (menit)</label>
                <input type="number" id="warningTime" value="5" min="1" max="60">
              </div>
              
              <button class="btn btn-primary" onclick="updateSessionSettings()">üíæ Update Session Settings</button>
            </div>

            <div>
              <h4>Data Management</h4>
              <div class="form-group">
                <label>Auto-sync Interval (detik)</label>
                <input type="number" id="syncInterval" value="30" min="10" max="300">
              </div>
              
              <div class="form-group">
                <label>Max Records per Page</label>
                <input type="number" id="recordsPerPage" value="5" min="5" max="50">
              </div>
              
              <button class="btn btn-primary" onclick="updateDataSettings()">üíæ Update Data Settings</button>
            </div>

            <div>
              <h4>Security Settings</h4>
              <div class="form-group">
                <label>Max Login Attempts</label>
                <input type="number" id="maxLoginAttempts" value="3" min="1" max="10">
              </div>
              
              <div class="form-group">
                <label>Account Lock Duration (menit)</label>
                <input type="number" id="lockDuration" value="30" min="5" max="1440">
              </div>
              
              <button class="btn btn-primary" onclick="updateSecuritySettings()">üíæ Update Security Settings</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>üíæ Backup & Restore</h3>
          <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <button class="btn btn-success" onclick="backupData()">üì• Backup Data</button>
            <button class="btn btn-warning" onclick="exportUserSessions()">üìã Export User Sessions</button>
            <button class="btn btn-danger" onclick="clearOldSessions()">üóëÔ∏è Clear Expired Sessions</button>
          </div>
        </div>
      </div>

      <!-- Tab Content: Data Monitoring -->
      <div id="data-monitoring" class="tab-content">
        <div class="card">
          <h3>üìä Monitoring Data Submission</h3>
          
          <div style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="refreshSubmissionData()">üîÑ Refresh</button>
            <button class="btn btn-success" onclick="exportSubmissionReport()">üìä Export Laporan</button>
          </div>

          <div id="submissionChart" style="height: 300px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
            <p>üìà Chart submission per hari (akan diimplementasikan)</p>
          </div>

          <div class="settings-grid">
            <div class="card">
              <h4>Submission Hari Ini</h4>
              <div class="stat-number" style="color: #3498db;" id="todaySubmissions">0</div>
            </div>
            
            <div class="card">
              <h4>Submission Minggu Ini</h4>
              <div class="stat-number" style="color: #2ecc71;" id="weekSubmissions">0</div>
            </div>
            
            <div class="card">
              <h4>Submission Bulan Ini</h4>
              <div class="stat-number" style="color: #f39c12;" id="monthSubmissions">0</div>
            </div>
            
            <div class="card">
              <h4>Pending Sync</h4>
              <div class="stat-number" style="color: #e74c3c;" id="pendingSync">0</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script>
    // ============ CONFIGURATION ============
    
    const CONFIG = {
      scriptURL: 'https://script.google.com/macros/s/AKfycbwslZst7EduArRyv3kwU-eW8GPLpw5djtj_FR2KdHPjUHigtXm6awSNacoM3vm9gU7u/exec',
      adminSessionKey: 'ltt_admin_session',
      configStorageKey: 'ltt_admin_config'
    };

    // ============ GLOBAL VARIABLES ============
    
    let currentAdminSession = null;
    let sessionCheckInterval = null;
    let timeRemainingInterval = null;
    let currentConfig = {
      monthLock: {
        enabled: false,
        month: null,
        year: null,
        message: ''
      }
    };

    // ============ AUTHENTICATION SYSTEM ============
    
    const AdminAuth = {
      isLoggedIn: function() {
        const session = localStorage.getItem(CONFIG.adminSessionKey);
        if (!session) return false;
        
        try {
          const sessionData = JSON.parse(session);
          return Date.now() < sessionData.expiresAt && sessionData.role === 'admin';
        } catch {
          return false;
        }
      },
      
      getSession: function() {
        const session = localStorage.getItem(CONFIG.adminSessionKey);
        if (!session) return null;
        
        try {
          return JSON.parse(session);
        } catch {
          return null;
        }
      },
      
      logout: function() {
        localStorage.removeItem(CONFIG.adminSessionKey);
        window.location.href = 'login.html?type=admin';
      },
      
      validateSession: async function() {
        const session = this.getSession();
        if (!session) return false;
        
        try {
          const formData = new FormData();
          formData.append('action', 'validate_session');
          formData.append('session_id', session.sessionId);
          
          const response = await fetch(CONFIG.scriptURL, {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success && result.session) {
            const updatedSession = { ...session, ...result.session };
            localStorage.setItem(CONFIG.adminSessionKey, JSON.stringify(updatedSession));
            currentAdminSession = updatedSession;
            return true;
          } else {
            localStorage.removeItem(CONFIG.adminSessionKey);
            return false;
          }
        } catch (error) {
          console.log('Admin session validation failed:', error);
          return false;
        }
      }
    };

    // ============ UI FUNCTIONS ============
    
    function switchTab(tabId) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active from all buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(tabId).classList.add('active');
      
      // Mark button as active
      event.target.classList.add('active');
      
      // Load tab-specific data
      switch(tabId) {
        case 'user-sessions':
          loadUserSessions();
          break;
        case 'data-monitoring':
          loadSubmissionData();
          break;
        case 'month-control':
          loadMonthControlConfig();
          break;
      }
    }

    function showAlert(message, type = 'success') {
      const alertContainer = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      
      alertContainer.innerHTML = '';
      alertContainer.appendChild(alert);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        if (alert.parentNode) {
          alert.parentNode.removeChild(alert);
        }
      }, 5000);
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ============ CONFIG MANAGEMENT ============
    
    function saveConfigLocally(config) {
      localStorage.setItem(CONFIG.configStorageKey, JSON.stringify(config));
      currentConfig = config;
    }

    function loadConfigLocally() {
      const saved = localStorage.getItem(CONFIG.configStorageKey);
      if (saved) {
        try {
          currentConfig = JSON.parse(saved);
        } catch (e) {
          console.log('Error loading config:', e);
        }
      }
    }

    // ============ MONTH LOCK FUNCTIONALITY ============
    
    async function loadMonthControlConfig() {
      try {
        // Load from localStorage first
        loadConfigLocally();
        updateLockStatusDisplay();
        
        // Try to sync with server if possible
        const formData = new FormData();
        formData.append('action', 'get_config');
        formData.append('session_id', currentAdminSession.sessionId);
        
        const response = await fetch(CONFIG.scriptURL, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.success && result.config) {
          currentConfig = result.config;
          saveConfigLocally(currentConfig);
          updateLockStatusDisplay();
        }
      } catch (error) {
        console.log('Error loading month config from server:', error);
        // Continue with local config
        showAlert('Menggunakan konfigurasi lokal. Koneksi server mungkin bermasalah.', 'warning');
      }
    }

    function updateLockStatusDisplay() {
      const display = document.getElementById('lockStatusDisplay');
      const toggleBtn = document.getElementById('lockToggleText');
      
      if (currentConfig.monthLock.enabled) {
        const monthNames = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                           'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        
        display.innerHTML = `
          <span class="lock-icon locked">üîí</span>
          <span class="locked">Terkunci: ${monthNames[currentConfig.monthLock.month]} ${currentConfig.monthLock.year}</span>
        `;
        toggleBtn.textContent = 'Buka Kunci';
      } else {
        display.innerHTML = `
          <span class="lock-icon unlocked">üîì</span>
          <span class="unlocked">Tidak ada kunci aktif</span>
        `;
        toggleBtn.textContent = 'Aktifkan Kunci';
      }
      
      // Update form values
      document.getElementById('lockedMonth').value = currentConfig.monthLock.month || '';
      document.getElementById('lockedYear').value = currentConfig.monthLock.year || new Date().getFullYear();
      document.getElementById('lockMessage').value = currentConfig.monthLock.message || '';
      
      // Broadcast config to all user tabs
      broadcastConfigUpdate();
    }

    async function setMonthLock() {
      const month = document.getElementById('lockedMonth').value;
      const year = document.getElementById('lockedYear').value;
      const message = document.getElementById('lockMessage').value;
      
      if (!month || !year) {
        showAlert('Pilih bulan dan tahun terlebih dahulu', 'error');
        return;
      }
      
      // Update local config immediately
      currentConfig.monthLock = {
        enabled: true,
        month: parseInt(month),
        year: parseInt(year),
        message: message
      };
      
      saveConfigLocally(currentConfig);
      updateLockStatusDisplay();
      
      try {
        // Try to sync with server
        const formData = new FormData();
        formData.append('action', 'set_config');
        formData.append('session_id', currentAdminSession.sessionId);
        formData.append('config_type', 'month_lock');
        formData.append('enabled', 'true');
        formData.append('month', month);
        formData.append('year', year);
        formData.append('message', message);
        
        const response = await fetch(CONFIG.scriptURL, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
          showAlert(`Kunci bulan ${getMonthName(month)} ${year} berhasil diaktifkan dan disimpan ke server`, 'success');
        } else {
          showAlert(`Kunci bulan berhasil diaktifkan secara lokal. Error server: ${result.error}`, 'warning');
        }
      } catch (error) {
        showAlert(`Kunci bulan berhasil diaktifkan secara lokal. Koneksi server bermasalah: ${error.message}`, 'warning');
      }
    }

    async function toggleMonthLock() {
      const newEnabled = !currentConfig.monthLock.enabled;
      
      // Update local config immediately
      currentConfig.monthLock.enabled = newEnabled;
      saveConfigLocally(currentConfig);
      updateLockStatusDisplay();
      
      try {
        // Try to sync with server
        const formData = new FormData();
        formData.append('action', 'set_config');
        formData.append('session_id', currentAdminSession.sessionId);
        formData.append('config_type', 'month_lock');
        formData.append('enabled', newEnabled.toString());
        formData.append('month', currentConfig.monthLock.month || '');
        formData.append('year', currentConfig.monthLock.year || '');
        formData.append('message', currentConfig.monthLock.message || '');
        
        const response = await fetch(CONFIG.scriptURL, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        const status = newEnabled ? 'diaktifkan' : 'dinonaktifkan';
        if (result.success) {
          showAlert(`Kunci bulan berhasil ${status} dan disimpan ke server`, 'success');
        } else {
          showAlert(`Kunci bulan berhasil ${status} secara lokal. Error server: ${result.error}`, 'warning');
        }
      } catch (error) {
        const status = newEnabled ? 'diaktifkan' : 'dinonaktifkan';
        showAlert(`Kunci bulan berhasil ${status} secara lokal. Koneksi server bermasalah: ${error.message}`, 'warning');
      }
    }

    function getMonthName(monthNum) {
      const months = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                     'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      return months[monthNum] || '';
    }

    function broadcastMessage() {
      const message = document.getElementById('lockMessage').value;
      if (!message.trim()) {
        showAlert('Masukkan pesan terlebih dahulu', 'error');
        return;
      }
      
      // Simpan pesan untuk ditampilkan ke user
      const broadcastData = {
        message: message,
        timestamp: Date.now(),
        id: Date.now()
      };
      
      localStorage.setItem('ltt_admin_broadcast', JSON.stringify(broadcastData));
      
      // Broadcast ke semua tab
      if (typeof BroadcastChannel !== 'undefined') {
        const channel = new BroadcastChannel('ltt_admin_updates');
        channel.postMessage({
          type: 'ADMIN_MESSAGE',
          data: { message: message, timestamp: Date.now() }
        });
      }
      
      showAlert('Pesan berhasil dikirim ke semua user', 'success');
    }

    function broadcastConfigUpdate() {
      // Broadcast config update to all user tabs
      if (typeof BroadcastChannel !== 'undefined') {
        const channel = new BroadcastChannel('ltt_admin_updates');
        channel.postMessage({
          type: 'MONTH_LOCK_UPDATE',
          data: { 
            config: currentConfig.monthLock,
            timestamp: Date.now()
          }
        });
      }
      
      // Also save to a shared storage that index.html can read
      localStorage.setItem('ltt_month_lock_config', JSON.stringify(currentConfig.monthLock));
    }

    // ============ USER SESSION MANAGEMENT ============
    
    async function loadUserSessions() {
      document.getElementById('userLoading').style.display = 'block';
      document.getElementById('userTable').style.display = 'none';
      
      try {
        const formData = new FormData();
        formData.append('action', 'get_users');
        formData.append('session_id', currentAdminSession.sessionId);
        
        const response = await fetch(CONFIG.scriptURL, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
          displayUserTable(result.users || []);
          updateUserStatistics(result.users || []);
        } else {
          showAlert('Gagal memuat data user: ' + result.error, 'error');
          // Show empty table
          displayUserTable([]);
          updateUserStatistics([]);
        }
      } catch (error) {
        console.log('Error loading user sessions:', error);
        showAlert('Error memuat data user: ' + error.message, 'error');
        displayUserTable([]);
        updateUserStatistics([]);
      } finally {
        document.getElementById('userLoading').style.display = 'none';
        document.getElementById('userTable').style.display = 'table';
      }
    }

    function displayUserTable(users) {
      const tbody = document.getElementById('userTableBody');
      tbody.innerHTML = '';
      
      if (users.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="6" style="text-align: center; color: #666;">
            Tidak ada user yang sedang login
          </td>
        `;
        tbody.appendChild(row);
        return;
      }
      
      users.forEach(user => {
        const row = document.createElement('tr');
        const timeLeft = user.expiresAt - Date.now();
        const timeLeftText = timeLeft > 0 ? formatTimeLeft(timeLeft) : 'Expired';
        const isActive = user.status === 'active' && timeLeft > 0;
        
        row.innerHTML = `
          <td>
            <span class="status-indicator ${isActive ? 'status-online' : 'status-offline'}"></span>
            ${isActive ? 'Online' : 'Offline'}
          </td>
          <td>${user.userCode}</td>
          <td>${user.penyuluhName}</td>
          <td>${new Date(user.loginTime).toLocaleString()}</td>
          <td>${timeLeftText}</td>
          <td>
            ${isActive ? `
              <button class="btn btn-warning" onclick="extendUserSession('${user.sessionId}')">‚è∞ Perpanjang</button>
              <button class="btn btn-danger" onclick="forceLogoutUser('${user.sessionId}')">üö™ Logout</button>
            ` : `
              <span style="color: #666;">Tidak ada aksi</span>
            `}
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    function formatTimeLeft(milliseconds) {
      const hours = Math.floor(milliseconds / (1000 * 60 * 60));
      const minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
      return `${hours}j ${minutes}m`;
    }

    function updateUserStatistics(users) {
      const totalUsers = users.length;
      const activeUsers = users.filter(u => u.status === 'active' && (u.expiresAt - Date.now()) > 0).length;
      const activeSessions = activeUsers;
      
      document.getElementById('totalUsers').textContent = totalUsers;
      document.getElementById('activeUsers').textContent = activeUsers;
      document.getElementById('activeSessions').textContent = activeSessions;
    }

    async function extendUserSession(sessionId) {
      if (confirm('Perpanjang session user ini?')) {
        try {
          const formData = new FormData();
          formData.append('action', 'extend_user_session');
          formData.append('session_id', currentAdminSession.sessionId);
          formData.append('target_session_id', sessionId);
          formData.append('hours', '8');
          
          const response = await fetch(CONFIG.scriptURL, {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            showAlert('Session user berhasil diperpanjang', 'success');
            setTimeout(() => loadUserSessions(), 1000);
          } else {
            showAlert('Gagal memperpanjang session: ' + result.error, 'error');
          }
        } catch (error) {
          showAlert('Error: ' + error.message, 'error');
        }
      }
    }

    async function forceLogoutUser(sessionId) {
      if (confirm('Yakin ingin logout user ini?')) {
        try {
          const formData = new FormData();
          formData.append('action', 'force_logout_user');
          formData.append('session_id', currentAdminSession.sessionId);
          formData.append('target_session_id', sessionId);
          
          const response = await fetch(CONFIG.scriptURL, {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            showAlert('User berhasil di-logout', 'success');
            
            // Broadcast logout to user
            if (typeof BroadcastChannel !== 'undefined') {
              const channel = new BroadcastChannel('ltt_admin_updates');
              channel.postMessage({
                type: 'FORCE_LOGOUT',
                data: { sessionId: sessionId }
              });
            }
            
            setTimeout(() => loadUserSessions(), 1000);
          } else {
            showAlert('Gagal logout user: ' + result.error, 'error');
          }
        } catch (error) {
          showAlert('Error: ' + error.message, 'error');
        }
      }
    }

    function refreshUserData() {
      loadUserSessions();
      showAlert('Data user berhasil direfresh', 'success');
    }

    function forceLogoutAll() {
      if (confirm('Yakin ingin logout SEMUA user? Tindakan ini tidak dapat dibatalkan.')) {
        // Broadcast logout semua user
        if (typeof BroadcastChannel !== 'undefined') {
          const channel = new BroadcastChannel('ltt_admin_updates');
          channel.postMessage({
            type: 'FORCE_LOGOUT_ALL',
            data: { timestamp: Date.now() }
          });
        }
        
        showAlert('Semua user berhasil di-logout', 'warning');
        setTimeout(() => loadUserSessions(), 2000);
      }
    }

    function extendAllSessions() {
      if (confirm('Perpanjang semua session aktif?')) {
        showAlert('Semua session aktif berhasil diperpanjang', 'success');
        setTimeout(() => loadUserSessions(), 1000);
      }
    }

    // ============ SYSTEM SETTINGS ============
    
    async function updateSessionSettings() {
      const duration = document.getElementById('sessionDuration').value;
      const warningTime = document.getElementById('warningTime').value;
      
      try {
        const formData = new FormData();
        formData.append('action', 'update_session_settings');
        formData.append('session_id', currentAdminSession.sessionId);
        formData.append('duration', duration);
        formData.append('warning', warningTime);
        
        const response = await fetch(CONFIG.scriptURL, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Broadcast settings update
          if (typeof BroadcastChannel !== 'undefined') {
            const channel = new BroadcastChannel('ltt_admin_updates');
            channel.postMessage({
              type: 'SESSION_SETTINGS_UPDATE',
              data: { duration: duration, warningTime: warningTime }
            });
          }
          
          showAlert('Pengaturan session berhasil diupdate', 'success');
        } else {
          showAlert('Gagal mengupdate pengaturan session: ' + result.error, 'error');
        }
      } catch (error) {
        showAlert('Error: ' + error.message, 'error');
      }
    }

    function updateDataSettings() {
      const syncInterval = document.getElementById('syncInterval').value;
      const recordsPerPage = document.getElementById('recordsPerPage').value;
      
      // Save settings to localStorage for now
      localStorage.setItem('ltt_data_settings', JSON.stringify({
        syncInterval: parseInt(syncInterval),
        recordsPerPage: parseInt(recordsPerPage)
      }));
      
      showAlert('Pengaturan data berhasil diupdate', 'success');
    }

    function updateSecuritySettings() {
      const maxAttempts = document.getElementById('maxLoginAttempts').value;
      const lockDuration = document.getElementById('lockDuration').value;
      
      // Save security settings to localStorage for now
      localStorage.setItem('ltt_security_settings', JSON.stringify({
        maxLoginAttempts: parseInt(maxAttempts),
        lockDuration: parseInt(lockDuration)
      }));
      
      showAlert('Pengaturan keamanan berhasil diupdate', 'success');
    }

    // ============ DATA MONITORING ============
    
    async function loadSubmissionData() {
      try {
        const response = await fetch(CONFIG.scriptURL + '?stats=1');
        const stats = await response.json();
        
        document.getElementById('todaySubmissions').textContent = stats.todaySubmissions || 0;
        document.getElementById('weekSubmissions').textContent = stats.weekSubmissions || 0;
        document.getElementById('monthSubmissions').textContent = stats.monthSubmissions || 0;
        document.getElementById('pendingSync').textContent = stats.pendingSync || 0;
        document.getElementById('totalSubmissions').textContent = stats.totalSubmissions || 0;
      } catch (error) {
        console.log('Error loading submission data:', error);
        // Set default values
        document.getElementById('todaySubmissions').textContent = '0';
        document.getElementById('weekSubmissions').textContent = '0';
        document.getElementById('monthSubmissions').textContent = '0';
        document.getElementById('pendingSync').textContent = '0';
        document.getElementById('totalSubmissions').textContent = '0';
      }
    }

    function refreshSubmissionData() {
      loadSubmissionData();
      showAlert('Data submission berhasil direfresh', 'success');
    }

    function exportSubmissionReport() {
      const reportData = {
        timestamp: new Date().toISOString(),
        todaySubmissions: document.getElementById('todaySubmissions').textContent,
        weekSubmissions: document.getElementById('weekSubmissions').textContent,
        monthSubmissions: document.getElementById('monthSubmissions').textContent,
        pendingSync: document.getElementById('pendingSync').textContent,
        totalSubmissions: document.getElementById('totalSubmissions').textContent
      };
      
      const dataStr = JSON.stringify(reportData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `submission_report_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
      showAlert('Laporan berhasil diexport', 'success');
    }

    // ============ BACKUP & RESTORE ============
    
    function backupData() {
      const backupData = {
        config: currentConfig,
        timestamp: new Date().toISOString(),
        version: '2.0'
      };
      
      const dataStr = JSON.stringify(backupData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `ltt_admin_backup_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
      showAlert('Backup berhasil dibuat', 'success');
    }

    function exportUserSessions() {
      // Export current user session data
      const sessionData = {
        exportTime: new Date().toISOString(),
        totalUsers: document.getElementById('totalUsers').textContent,
        activeUsers: document.getElementById('activeUsers').textContent,
        activeSessions: document.getElementById('activeSessions').textContent
      };
      
      const dataStr = JSON.stringify(sessionData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `user_sessions_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
      showAlert('Data session berhasil diexport', 'success');
    }

    function clearOldSessions() {
      if (confirm('Hapus semua session yang sudah expired?')) {
        // This would be handled server-side in real implementation
        showAlert('Session expired berhasil dihapus', 'success');
      }
    }

    // ============ SESSION MONITORING ============
    
    function startAdminSessionMonitoring() {
      // Check session every 30 seconds
      sessionCheckInterval = setInterval(async () => {
        const isValid = await AdminAuth.validateSession();
        if (!isValid) {
          showAlert('‚ùå Sesi admin telah berakhir. Silakan login kembali.', 'error');
          setTimeout(() => AdminAuth.logout(), 2000);
        }
      }, 30000);
      
      // Update time remaining display
      timeRemainingInterval = setInterval(() => {
        updateAdminTimeDisplay();
      }, 60000);
    }

    function updateAdminTimeDisplay() {
      const session = AdminAuth.getSession();
      if (session) {
        const timeLeft = session.expiresAt - Date.now();
        const hours = Math.floor(timeLeft / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        
        if (timeLeft > 0) {
          document.getElementById('timeRemaining').textContent = `${hours}j ${minutes}m`;
        } else {
          document.getElementById('timeRemaining').textContent = 'Expired';
        }
      }
    }

    function updateAdminInfo() {
      const session = AdminAuth.getSession();
      if (session) {
        document.getElementById('adminName').textContent = session.penyuluhName || 'Administrator';
        document.getElementById('loginTime').textContent = new Date(session.loginTime).toLocaleTimeString();
        currentAdminSession = session;
        updateAdminTimeDisplay();
      }
    }

    // ============ AUTHENTICATION & INITIALIZATION ============
    
    function checkAuthentication() {
      const authProtection = document.getElementById('authProtection');
      
      if (!AdminAuth.isLoggedIn()) {
        // Tidak ada sesi admin valid, redirect ke login
        setTimeout(() => {
          window.location.href = 'login.html?type=admin';
        }, 1500);
        return false;
      }
      
      // Validate session with server
      AdminAuth.validateSession().then(isValid => {
        if (isValid) {
          // Sesi valid, sembunyikan protection overlay
          authProtection.style.display = 'none';
          
          // Update admin info di header
          updateAdminInfo();
          
          // Start session monitoring
          startAdminSessionMonitoring();
          
          // Initialize admin panel
          initializeAdminPanel();
        } else {
          // Session invalid, redirect
          setTimeout(() => {
            window.location.href = 'login.html?type=admin';
          }, 1500);
        }
      });
      
      return true;
    }

    function initializeAdminPanel() {
      console.log('Initializing admin panel...');
      
      // Load initial data
      loadMonthControlConfig();
      loadUserSessions();
      loadSubmissionData();
      
      // Load settings from localStorage
      loadSettings();
      
      console.log('Admin panel initialized successfully');
    }

    function loadSettings() {
      // Load data settings
      const dataSettings = JSON.parse(localStorage.getItem('ltt_data_settings') || '{}');
      if (dataSettings.syncInterval) {
        document.getElementById('syncInterval').value = dataSettings.syncInterval;
      }
      if (dataSettings.recordsPerPage) {
        document.getElementById('recordsPerPage').value = dataSettings.recordsPerPage;
      }
      
      // Load security settings
      const securitySettings = JSON.parse(localStorage.getItem('ltt_security_settings') || '{}');
      if (securitySettings.maxLoginAttempts) {
        document.getElementById('maxLoginAttempts').value = securitySettings.maxLoginAttempts;
      }
      if (securitySettings.lockDuration) {
        document.getElementById('lockDuration').value = securitySettings.lockDuration;
      }
    }

    function logout() {
      if (confirm('Apakah Anda yakin ingin logout dari admin panel?')) {
        AdminAuth.logout();
      }
    }

    // ============ PERIODIC DATA SYNC ============
    
    // Auto refresh user data every 30 seconds
    setInterval(() => {
      if (document.getElementById('user-sessions').classList.contains('active')) {
        loadUserSessions();
      }
    }, 30000);

    // Auto refresh submission data every 60 seconds
    setInterval(() => {
      if (document.getElementById('data-monitoring').classList.contains('active')) {
        loadSubmissionData();
      }
    }, 60000);

    // Sync config with server every 2 minutes
    setInterval(() => {
      if (document.getElementById('month-control').classList.contains('active')) {
        loadMonthControlConfig();
      }
    }, 120000);

    // ============ EVENT LISTENERS ============
    
    // Handle page visibility change
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        // Page visible again, check session
        if (AdminAuth.isLoggedIn()) {
          AdminAuth.validateSession().then(isValid => {
            if (!isValid) {
              AdminAuth.logout();
            }
          });
        }
      }
    });

    // Handle beforeunload
    window.addEventListener('beforeunload', function(e) {
      if (!AdminAuth.isLoggedIn()) {
        e.preventDefault();
        e.returnValue = '';
        return 'Session admin telah berakhir';
      }
    });

    // Cleanup intervals saat page unload
    window.addEventListener('unload', function() {
      if (sessionCheckInterval) {
        clearInterval(sessionCheckInterval);
      }
      if (timeRemainingInterval) {
        clearInterval(timeRemainingInterval);
      }
    });

    // ============ STARTUP ============
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      checkAuthentication();
    });

    // Make objects available globally for debugging
    window.AdminAuth = AdminAuth;
    window.currentConfig = currentConfig;
  </script>
</body>
</html>
