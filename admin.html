<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel - Form Monitoring LTT & LTP</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .admin-header {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
    }

    .admin-header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .admin-header p {
      opacity: 0.9;
      font-size: 16px;
    }

    .admin-info {
      position: absolute;
      top: 20px;
      right: 30px;
      text-align: right;
      font-size: 14px;
    }

    .logout-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
      transition: background 0.3s ease;
    }

    .logout-btn:hover {
      background: #c0392b;
    }

    .admin-content {
      padding: 40px;
    }

    .admin-tabs {
      display: flex;
      margin-bottom: 30px;
      background: #f8f9fa;
      border-radius: 10px;
      padding: 5px;
    }

    .tab-btn {
      flex: 1;
      padding: 15px 20px;
      background: transparent;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      color: #666;
    }

    .tab-btn.active {
      background: #3498db;
      color: white;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .card {
      background: white;
      border: 1px solid #e1e8ed;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .card h3 {
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 20px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #34495e;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    .btn-primary {
      background: #3498db;
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    .btn-success {
      background: #2ecc71;
      color: white;
    }

    .btn-success:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    .btn-danger:hover {
      background: #c0392b;
      transform: translateY(-2px);
    }

    .btn-warning {
      background: #f39c12;
      color: white;
    }

    .btn-warning:hover {
      background: #e67e22;
      transform: translateY(-2px);
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
    }

    .user-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .user-table th,
    .user-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e1e8ed;
    }

    .user-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #2c3e50;
    }

    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-online {
      background: #2ecc71;
    }

    .status-offline {
      background: #95a5a6;
    }

    .month-lock-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .lock-status {
      display: flex;
      align-items: center;
      font-weight: 600;
    }

    .lock-icon {
      font-size: 20px;
      margin-right: 10px;
    }

    .locked {
      color: #e74c3c;
    }

    .unlocked {
      color: #2ecc71;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      z-index: 10000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      background: #2ecc71;
    }

    .toast.error {
      background: #e74c3c;
    }

    .toast.warning {
      background: #f39c12;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      padding: 25px;
      border-radius: 12px;
      text-align: center;
    }

    .stat-card.users {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
    }

    .stat-card.sessions {
      background: linear-gradient(135deg, #f39c12, #e67e22);
    }

    .stat-card.submissions {
      background: linear-gradient(135deg, #9b59b6, #8e44ad);
    }

    .stat-number {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Auth protection overlay */
    .auth-protection {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      z-index: 10000;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .auth-loading {
      text-align: center;
      color: #2c3e50;
    }

    @media (max-width: 768px) {
      .admin-content {
        padding: 20px;
      }
      
      .admin-tabs {
        flex-direction: column;
      }
      
      .tab-btn {
        margin-bottom: 5px;
      }
      
      .settings-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <!-- Auth Protection Overlay -->
  <div id="authProtection" class="auth-protection">
    <div class="auth-loading">
      <div class="spinner"></div>
      <h3>Memverifikasi akses admin...</h3>
      <p>Mohon tunggu sebentar</p>
    </div>
  </div>

  <div class="admin-container">
    <div class="admin-header">
      <div class="admin-info">
        <div>Admin: <span id="adminName">***</span></div>
        <div>Login: <span id="loginTime">***</span></div>
        <button class="logout-btn" onclick="logout()">üö™ Logout</button>
      </div>
      
      <h1>üõ†Ô∏è Admin Panel</h1>
      <p>Sistem Administrasi Form Monitoring LTT & LTP</p>
    </div>

    <div class="admin-content">
      <!-- Statistics -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalUsers">0</div>
          <div class="stat-label">Total User</div>
        </div>
        <div class="stat-card users">
          <div class="stat-number" id="activeUsers">0</div>
          <div class="stat-label">User Online</div>
        </div>
        <div class="stat-card sessions">
          <div class="stat-number" id="activeSessions">0</div>
          <div class="stat-label">Sesi Aktif</div>
        </div>
        <div class="stat-card submissions">
          <div class="stat-number" id="totalSubmissions">0</div>
          <div class="stat-label">Total Submission</div>
        </div>
      </div>

      <!-- Admin Tabs -->
      <div class="admin-tabs">
        <button class="tab-btn active" onclick="switchTab('month-control')">üìÖ Kontrol Bulan</button>
        <button class="tab-btn" onclick="switchTab('user-sessions')">üë• Manajemen User</button>
        <button class="tab-btn" onclick="switchTab('system-settings')">‚öôÔ∏è Pengaturan Sistem</button>
        <button class="tab-btn" onclick="switchTab('data-monitoring')">üìä Monitoring Data</button>
      </div>

      <!-- Tab Content: Month Control -->
      <div id="month-control" class="tab-content active">
        <div class="card">
          <h3>üîí Kontrol Kunci Bulan Timestamp</h3>
          
          <!-- Current Status -->
          <div class="month-lock-status">
            <div class="lock-status" id="lockStatusDisplay">
              <span class="lock-icon">üîí</span>
              <span>Status: Loading...</span>
            </div>
            <button class="btn btn-warning" onclick="toggleMonthLock()">
              <span id="lockToggleText">Toggle Lock</span>
            </button>
          </div>

          <div class="settings-grid">
            <div>
              <div class="form-group">
                <label>Bulan yang Dikunci</label>
                <select id="lockedMonth">
                  <option value="">Tidak ada yang dikunci</option>
                  <option value="1">Januari</option>
                  <option value="2">Februari</option>
                  <option value="3">Maret</option>
                  <option value="4">April</option>
                  <option value="5">Mei</option>
                  <option value="6">Juni</option>
                  <option value="7">Juli</option>
                  <option value="8">Agustus</option>
                  <option value="9">September</option>
                  <option value="10">Oktober</option>
                  <option value="11">November</option>
                  <option value="12">Desember</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>Tahun</label>
                <input type="number" id="lockedYear" value="2025" min="2020" max="2030">
              </div>
              
              <button class="btn btn-primary" onclick="setMonthLock()">üíæ Simpan Pengaturan</button>
            </div>

            <div>
              <div class="form-group">
                <label>Pesan untuk User (Optional)</label>
                <textarea id="lockMessage" rows="4" style="width: 100%; padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px;" placeholder="Contoh: Input data untuk bulan Januari 2025 telah ditutup. Silakan hubungi admin jika ada keperluan mendesak."></textarea>
              </div>
              
              <button class="btn btn-success" onclick="broadcastMessage()">üì¢ Kirim Pesan ke Semua User</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab Content: User Sessions -->
      <div id="user-sessions" class="tab-content">
        <div class="card">
          <h3>üë• Manajemen User & Session</h3>
          
          <div style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="refreshUserData()">üîÑ Refresh Data</button>
            <button class="btn btn-danger" onclick="forceLogoutAll()">üö™ Logout Semua User</button>
            <button class="btn btn-warning" onclick="extendAllSessions()">‚è∞ Perpanjang Semua Sesi</button>
          </div>

          <div class="loading" id="userLoading">
            <div class="spinner"></div>
            <p>Memuat data user...</p>
          </div>

          <table class="user-table" id="userTable" style="display: none;">
            <thead>
              <tr>
                <th>Status</th>
                <th>Kode User</th>
                <th>Nama Penyuluh</th>
                <th>Waktu Login</th>
                <th>Sisa Sesi</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="userTableBody">
            </tbody>
          </table>
        </div>
      </div>

      <!-- Tab Content: System Settings -->
      <div id="system-settings" class="tab-content">
        <div class="card">
          <h3>‚öôÔ∏è Pengaturan Sistem</h3>
          
          <div class="settings-grid">
            <div>
              <h4>Session Settings</h4>
              <div class="form-group">
                <label>Durasi Session (jam)</label>
                <input type="number" id="sessionDuration" value="8" min="1" max="24">
              </div>
              
              <div class="form-group">
                <label>Warning Time (menit)</label>
                <input type="number" id="warningTime" value="5" min="1" max="60">
              </div>
              
              <button class="btn btn-primary" onclick="updateSessionSettings()">üíæ Update Session Settings</button>
            </div>

            <div>
              <h4>Data Management</h4>
              <div class="form-group">
                <label>Auto-sync Interval (detik)</label>
                <input type="number" id="syncInterval" value="30" min="10" max="300">
              </div>
              
              <div class="form-group">
                <label>Max Records per Page</label>
                <input type="number" id="recordsPerPage" value="5" min="5" max="50">
              </div>
              
              <button class="btn btn-primary" onclick="updateDataSettings()">üíæ Update Data Settings</button>
            </div>

            <div>
              <h4>Security Settings</h4>
              <div class="form-group">
                <label>Max Login Attempts</label>
                <input type="number" id="maxLoginAttempts" value="3" min="1" max="10">
              </div>
              
              <div class="form-group">
                <label>Account Lock Duration (menit)</label>
                <input type="number" id="lockDuration" value="30" min="5" max="1440">
              </div>
              
              <button class="btn btn-primary" onclick="updateSecuritySettings()">üíæ Update Security Settings</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>üíæ Backup & Restore</h3>
          <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <button class="btn btn-success" onclick="backupData()">üì• Backup Data</button>
            <button class="btn btn-warning" onclick="exportUserSessions()">üìã Export User Sessions</button>
            <button class="btn btn-danger" onclick="clearOldSessions()">üóëÔ∏è Clear Expired Sessions</button>
          </div>
        </div>
      </div>

      <!-- Tab Content: Data Monitoring -->
      <div id="data-monitoring" class="tab-content">
        <div class="card">
          <h3>üìä Monitoring Data Submission</h3>
          
          <div style="margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="refreshSubmissionData()">üîÑ Refresh</button>
            <button class="btn btn-success" onclick="exportSubmissionReport()">üìä Export Laporan</button>
          </div>

          <div id="submissionChart" style="height: 300px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
            <p>üìà Chart submission per hari (akan diimplementasikan)</p>
          </div>

          <div class="settings-grid">
            <div class="card">
              <h4>Submission Hari Ini</h4>
              <div class="stat-number" style="color: #3498db;" id="todaySubmissions">0</div>
            </div>
            
            <div class="card">
              <h4>Submission Minggu Ini</h4>
              <div class="stat-number" style="color: #2ecc71;" id="weekSubmissions">0</div>
            </div>
            
            <div class="card">
              <h4>Submission Bulan Ini</h4>
              <div class="stat-number" style="color: #f39c12;" id="monthSubmissions">0</div>
            </div>
            
            <div class="card">
              <h4>Pending Sync</h4>
              <div class="stat-number" style="color: #e74c3c;" id="pendingSync">0</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script>
    // ============ AUTHENTICATION SYSTEM ============
    
    const ADMIN_SESSION_KEY = 'ltt_admin_session';
    const SESSION_DURATION = 8 * 60 * 60 * 1000; // 8 jam
    
    // Admin authentication object
    const AdminAuth = {
      isLoggedIn: function() {
        const session = localStorage.getItem(ADMIN_SESSION_KEY);
        if (!session) return false;
        
        try {
          const sessionData = JSON.parse(session);
          return Date.now() < sessionData.expiresAt && sessionData.role === 'admin';
        } catch {
          return false;
        }
      },
      
      logout: function() {
        localStorage.removeItem(ADMIN_SESSION_KEY);
        window.location.href = 'login.html';
      },
      
      requireAuth: function() {
        if (!this.isLoggedIn()) {
          window.location.href = 'login.html';
          return false;
        }
        return true;
      },
      
      getSession: function() {
        const session = localStorage.getItem(ADMIN_SESSION_KEY);
        if (!session) return null;
        
        try {
          return JSON.parse(session);
        } catch {
          return null;
        }
      }
    };

    // ============ SYSTEM STATE ============
    
    let systemState = {
      monthLock: {
        enabled: false,
        month: null,
        year: null,
        message: ''
      },
      sessionSettings: {
        duration: 8,
        warningTime: 5
      },
      users: [],
      submissions: []
    };

    // ============ LOCAL STORAGE MANAGEMENT ============
    
    function saveSystemState() {
      localStorage.setItem('ltt_admin_state', JSON.stringify(systemState));
    }

    function loadSystemState() {
      const saved = localStorage.getItem('ltt_admin_state');
      if (saved) {
        try {
          systemState = { ...systemState, ...JSON.parse(saved) };
        } catch (e) {
          console.log('Error loading system state:', e);
        }
      }
    }

    // ============ UI FUNCTIONS ============
    
    function switchTab(tabId) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Remove active from all buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById(tabId).classList.add('active');
      
      // Mark button as active
      event.target.classList.add('active');
      
      // Load tab-specific data
      switch(tabId) {
        case 'user-sessions':
          loadUserSessions();
          break;
        case 'data-monitoring':
          loadSubmissionData();
          break;
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ============ MONTH LOCK FUNCTIONALITY ============
    
    function updateLockStatusDisplay() {
      const display = document.getElementById('lockStatusDisplay');
      const toggleBtn = document.getElementById('lockToggleText');
      
      if (systemState.monthLock.enabled) {
        const monthNames = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                           'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        
        display.innerHTML = `
          <span class="lock-icon locked">üîí</span>
          <span class="locked">Terkunci: ${monthNames[systemState.monthLock.month]} ${systemState.monthLock.year}</span>
        `;
        toggleBtn.textContent = 'Buka Kunci';
      } else {
        display.innerHTML = `
          <span class="lock-icon unlocked">üîì</span>
          <span class="unlocked">Tidak ada kunci aktif</span>
        `;
        toggleBtn.textContent = 'Aktifkan Kunci';
      }
      
      // Update form values
      document.getElementById('lockedMonth').value = systemState.monthLock.month || '';
      document.getElementById('lockedYear').value = systemState.monthLock.year || new Date().getFullYear();
      document.getElementById('lockMessage').value = systemState.monthLock.message || '';
    }

    function setMonthLock() {
      const month = document.getElementById('lockedMonth').value;
      const year = document.getElementById('lockedYear').value;
      const message = document.getElementById('lockMessage').value;
      
      if (!month || !year) {
        showToast('Pilih bulan dan tahun terlebih dahulu', 'error');
        return;
      }
      
      systemState.monthLock = {
        enabled: true,
        month: parseInt(month),
        year: parseInt(year),
        message: message
      };
      
      saveSystemState();
      updateLockStatusDisplay();
      
      // Broadcast to all users
      broadcastMonthLockUpdate();
      
      showToast(`Kunci bulan ${getMonthName(month)} ${year} berhasil diaktifkan`, 'success');
    }

    function toggleMonthLock() {
      systemState.monthLock.enabled = !systemState.monthLock.enabled;
      saveSystemState();
      updateLockStatusDisplay();
      
      // Broadcast to all users
      broadcastMonthLockUpdate();
      
      const status = systemState.monthLock.enabled ? 'diaktifkan' : 'dinonaktifkan';
      showToast(`Kunci bulan berhasil ${status}`, 'success');
    }

    function getMonthName(monthNum) {
      const months = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                     'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      return months[monthNum] || '';
    }

    function broadcastMonthLockUpdate() {
      // Simpan update ke localStorage yang bisa dibaca oleh form utama
      localStorage.setItem('ltt_month_lock_config', JSON.stringify(systemState.monthLock));
      
      // Broadcast ke semua tab terbuka (jika ada)
      if (typeof BroadcastChannel !== 'undefined') {
        const channel = new BroadcastChannel('ltt_admin_updates');
        channel.postMessage({
          type: 'MONTH_LOCK_UPDATE',
          data: systemState.monthLock
        });
      }
    }

    function broadcastMessage() {
      const message = document.getElementById('lockMessage').value;
      if (!message.trim()) {
        showToast('Masukkan pesan terlebih dahulu', 'error');
        return;
      }
      
      // Simpan pesan untuk ditampilkan ke user
      localStorage.setItem('ltt_admin_broadcast', JSON.stringify({
        message: message,
        timestamp: Date.now(),
        id: Date.now()
      }));
      
      // Broadcast ke semua tab
      if (typeof BroadcastChannel !== 'undefined') {
        const channel = new BroadcastChannel('ltt_admin_updates');
        channel.postMessage({
          type: 'ADMIN_MESSAGE',
          data: { message: message, timestamp: Date.now() }
        });
      }
      
      showToast('Pesan berhasil dikirim ke semua user', 'success');
    }

    // ============ USER SESSION MANAGEMENT ============
    
    function loadUserSessions() {
      document.getElementById('userLoading').style.display = 'block';
      document.getElementById('userTable').style.display = 'none';
      
      // Simulate loading (dalam implementasi nyata, ambil dari server)
      setTimeout(() => {
        const mockUsers = generateMockUserData();
        displayUserTable(mockUsers);
        document.getElementById('userLoading').style.display = 'none';
        document.getElementById('userTable').style.display = 'table';
      }, 1000);
    }

    function generateMockUserData() {
      const penyuluhNames = [
        'A.PURNAMA PUTRA', 'AAN PUJINURINSAN', 'ABDUL RAHMAN', 'AGUS SAIFUDDIN',
        'AGUSMANTO', 'AHADI', 'ALMIZAN', 'ALWAN SASRUDIN',
        'ANDI', 'ANDI WIHARDI', 'ANDI WILLIAM', 'ANTO SAPUTRA'
      ];
      
      const users = [];
      const now = Date.now();
      
      for (let i = 0; i < 8; i++) {
        const loginTime = now - Math.random() * 4 * 60 * 60 * 1000; // Random login within 4 hours
        const sessionExpiry = loginTime + 8 * 60 * 60 * 1000; // 8 hour session
        const isActive = sessionExpiry > now;
        
        users.push({
          id: `user_${i + 1}`,
          code: `USR${String(i + 1).padStart(3, '0')}`,
          name: penyuluhNames[i],
          loginTime: loginTime,
          sessionExpiry: sessionExpiry,
          isActive: isActive,
          lastActivity: now - Math.random() * 30 * 60 * 1000 // Last activity within 30 min
        });
      }
      
      return users;
    }

    function displayUserTable(users) {
      const tbody = document.getElementById('userTableBody');
      tbody.innerHTML = '';
      
      users.forEach(user => {
        const row = document.createElement('tr');
        const timeLeft = user.sessionExpiry - Date.now();
        const timeLeftText = timeLeft > 0 ? formatTimeLeft(timeLeft) : 'Expired';
        
        row.innerHTML = `
          <td>
            <span class="status-indicator ${user.isActive ? 'status-online' : 'status-offline'}"></span>
            ${user.isActive ? 'Online' : 'Offline'}
          </td>
          <td>${user.code}</td>
          <td>${user.name}</td>
          <td>${new Date(user.loginTime).toLocaleString()}</td>
          <td>${timeLeftText}</td>
          <td>
            ${user.isActive ? `
              <button class="btn btn-warning" onclick="extendUserSession('${user.id}')">‚è∞ Perpanjang</button>
              <button class="btn btn-danger" onclick="forceLogoutUser('${user.id}')">üö™ Logout</button>
            ` : `
              <button class="btn btn-success" onclick="reactivateUser('${user.id}')">üîÑ Reaktivasi</button>
            `}
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      // Update statistics
      updateUserStatistics(users);
    }

    function formatTimeLeft(milliseconds) {
      const hours = Math.floor(milliseconds / (1000 * 60 * 60));
      const minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
      return `${hours}j ${minutes}m`;
    }

    function updateUserStatistics(users) {
      const totalUsers = users.length;
      const activeUsers = users.filter(u => u.isActive).length;
      const activeSessions = activeUsers;
      const totalSubmissions = Math.floor(Math.random() * 150) + 50; // Mock data
      
      document.getElementById('totalUsers').textContent = totalUsers;
      document.getElementById('activeUsers').textContent = activeUsers;
      document.getElementById('activeSessions').textContent = activeSessions;
      document.getElementById('totalSubmissions').textContent = totalSubmissions;
    }

    function refreshUserData() {
      loadUserSessions();
      showToast('Data user berhasil direfresh', 'success');
    }

    function forceLogoutUser(userId) {
      if (confirm('Yakin ingin logout user ini?')) {
        // Dalam implementasi nyata, kirim perintah logout ke server
        // Dan hapus session user dari sistem
        
        // Simulasi broadcast logout ke user specific
        if (typeof BroadcastChannel !== 'undefined') {
          const channel = new BroadcastChannel('ltt_admin_updates');
          channel.postMessage({
            type: 'FORCE_LOGOUT',
            data: { userId: userId }
          });
        }
        
        showToast('User berhasil di-logout', 'success');
        setTimeout(() => refreshUserData(), 1000);
      }
    }

    function forceLogoutAll() {
      if (confirm('Yakin ingin logout SEMUA user? Tindakan ini tidak dapat dibatalkan.')) {
        // Broadcast logout semua user
        if (typeof BroadcastChannel !== 'undefined') {
          const channel = new BroadcastChannel('ltt_admin_updates');
          channel.postMessage({
            type: 'FORCE_LOGOUT_ALL',
            data: { timestamp: Date.now() }
          });
        }
        
        // Clear semua session di localStorage
        const keys = Object.keys(localStorage);
        keys.forEach(key => {
          if (key.startsWith('ltt_session') && key !== ADMIN_SESSION_KEY) {
            localStorage.removeItem(key);
          }
        });
        
        showToast('Semua user berhasil di-logout', 'warning');
        setTimeout(() => refreshUserData(), 1000);
      }
    }

    function extendUserSession(userId) {
      // Dalam implementasi nyata, extend session di server
      showToast('Session user berhasil diperpanjang', 'success');
      setTimeout(() => refreshUserData(), 1000);
    }

    function extendAllSessions() {
      if (confirm('Perpanjang semua session aktif?')) {
        showToast('Semua session aktif berhasil diperpanjang', 'success');
        setTimeout(() => refreshUserData(), 1000);
      }
    }

    function reactivateUser(userId) {
      if (confirm('Reaktivasi session user ini?')) {
        showToast('User berhasil direaktivasi', 'success');
        setTimeout(() => refreshUserData(), 1000);
      }
    }

    // ============ SYSTEM SETTINGS ============
    
    function updateSessionSettings() {
      const duration = document.getElementById('sessionDuration').value;
      const warningTime = document.getElementById('warningTime').value;
      
      systemState.sessionSettings = {
        duration: parseInt(duration),
        warningTime: parseInt(warningTime)
      };
      
      saveSystemState();
      
      // Broadcast settings update
      if (typeof BroadcastChannel !== 'undefined') {
        const channel = new BroadcastChannel('ltt_admin_updates');
        channel.postMessage({
          type: 'SESSION_SETTINGS_UPDATE',
          data: systemState.sessionSettings
        });
      }
      
      showToast('Pengaturan session berhasil diupdate', 'success');
    }

    function updateDataSettings() {
      const syncInterval = document.getElementById('syncInterval').value;
      const recordsPerPage = document.getElementById('recordsPerPage').value;
      
      // Save settings
      localStorage.setItem('ltt_data_settings', JSON.stringify({
        syncInterval: parseInt(syncInterval),
        recordsPerPage: parseInt(recordsPerPage)
      }));
      
      showToast('Pengaturan data berhasil diupdate', 'success');
    }

    function updateSecuritySettings() {
      const maxAttempts = document.getElementById('maxLoginAttempts').value;
      const lockDuration = document.getElementById('lockDuration').value;
      
      // Save security settings
      localStorage.setItem('ltt_security_settings', JSON.stringify({
        maxLoginAttempts: parseInt(maxAttempts),
        lockDuration: parseInt(lockDuration)
      }));
      
      showToast('Pengaturan keamanan berhasil diupdate', 'success');
    }

    // ============ DATA MONITORING ============
    
    function loadSubmissionData() {
      // Mock data untuk submission monitoring
      const today = new Date();
      const todaySubmissions = Math.floor(Math.random() * 20) + 5;
      const weekSubmissions = Math.floor(Math.random() * 100) + 50;
      const monthSubmissions = Math.floor(Math.random() * 300) + 150;
      const pendingSync = Math.floor(Math.random() * 10);
      
      document.getElementById('todaySubmissions').textContent = todaySubmissions;
      document.getElementById('weekSubmissions').textContent = weekSubmissions;
      document.getElementById('monthSubmissions').textContent = monthSubmissions;
      document.getElementById('pendingSync').textContent = pendingSync;
    }

    function refreshSubmissionData() {
      loadSubmissionData();
      showToast('Data submission berhasil direfresh', 'success');
    }

    function exportSubmissionReport() {
      // Mock export functionality
      const reportData = {
        timestamp: new Date().toISOString(),
        todaySubmissions: document.getElementById('todaySubmissions').textContent,
        weekSubmissions: document.getElementById('weekSubmissions').textContent,
        monthSubmissions: document.getElementById('monthSubmissions').textContent,
        pendingSync: document.getElementById('pendingSync').textContent
      };
      
      const dataStr = JSON.stringify(reportData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `submission_report_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
      showToast('Laporan berhasil diexport', 'success');
    }

    // ============ BACKUP & RESTORE ============
    
    function backupData() {
      const backupData = {
        systemState: systemState,
        timestamp: new Date().toISOString(),
        version: '1.0'
      };
      
      const dataStr = JSON.stringify(backupData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `ltt_admin_backup_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
      showToast('Backup berhasil dibuat', 'success');
    }

    function exportUserSessions() {
      // Mock user session export
      const sessionData = {
        exportTime: new Date().toISOString(),
        totalUsers: document.getElementById('totalUsers').textContent,
        activeUsers: document.getElementById('activeUsers').textContent,
        activeSessions: document.getElementById('activeSessions').textContent
      };
      
      const dataStr = JSON.stringify(sessionData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `user_sessions_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
      showToast('Data session berhasil diexport', 'success');
    }

    function clearOldSessions() {
      if (confirm('Hapus semua session yang sudah expired?')) {
        // Clear expired sessions from localStorage
        const keys = Object.keys(localStorage);
        let clearedCount = 0;
        
        keys.forEach(key => {
          if (key.startsWith('ltt_session')) {
            try {
              const session = JSON.parse(localStorage.getItem(key));
              if (session.expiresAt && Date.now() > session.expiresAt) {
                localStorage.removeItem(key);
                clearedCount++;
              }
            } catch (e) {
              // Invalid session data, remove it
              localStorage.removeItem(key);
              clearedCount++;
            }
          }
        });
        
        showToast(`${clearedCount} session expired berhasil dihapus`, 'success');
      }
    }

    // ============ AUTHENTICATION & INITIALIZATION ============
    
    function checkAuthentication() {
      const authProtection = document.getElementById('authProtection');
      
      if (!AdminAuth.isLoggedIn()) {
        // Tidak ada sesi admin valid, redirect ke login
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 1500);
        return false;
      }
      
      // Sesi admin valid, sembunyikan protection overlay
      authProtection.style.display = 'none';
      
      // Update admin info di header
      updateAdminInfo();
      
      return true;
    }

    function updateAdminInfo() {
      const session = AdminAuth.getSession();
      if (session) {
        document.getElementById('adminName').textContent = session.adminName || 'Administrator';
        document.getElementById('loginTime').textContent = new Date(session.loginTime).toLocaleTimeString();
      }
    }

    function logout() {
      if (confirm('Apakah Anda yakin ingin logout dari admin panel?')) {
        AdminAuth.logout();
      }
    }

    // ============ INITIALIZATION ============
    
    function initializeAdmin() {
      console.log('Initializing admin panel...');
      
      if (!checkAuthentication()) {
        return; // Stop if not authenticated
      }
      
      // Load system state
      loadSystemState();
      
      // Initialize UI
      updateLockStatusDisplay();
      loadUserSessions();
      loadSubmissionData();
      
      // Load settings from localStorage
      loadSettings();
      
      console.log('Admin panel initialized successfully');
    }

    function loadSettings() {
      // Load session settings
      if (systemState.sessionSettings) {
        document.getElementById('sessionDuration').value = systemState.sessionSettings.duration;
        document.getElementById('warningTime').value = systemState.sessionSettings.warningTime;
      }
      
      // Load data settings
      const dataSettings = JSON.parse(localStorage.getItem('ltt_data_settings') || '{}');
      if (dataSettings.syncInterval) {
        document.getElementById('syncInterval').value = dataSettings.syncInterval;
      }
      if (dataSettings.recordsPerPage) {
        document.getElementById('recordsPerPage').value = dataSettings.recordsPerPage;
      }
      
      // Load security settings
      const securitySettings = JSON.parse(localStorage.getItem('ltt_security_settings') || '{}');
      if (securitySettings.maxLoginAttempts) {
        document.getElementById('maxLoginAttempts').value = securitySettings.maxLoginAttempts;
      }
      if (securitySettings.lockDuration) {
        document.getElementById('lockDuration').value = securitySettings.lockDuration;
      }
    }

    // ============ BROADCAST CHANNEL LISTENER ============
    
    // Listen for updates from other admin panels (if multiple admins)
    if (typeof BroadcastChannel !== 'undefined') {
      const channel = new BroadcastChannel('ltt_admin_updates');
      
      channel.addEventListener('message', (event) => {
        const { type, data } = event.data;
        
        switch (type) {
          case 'USER_LOGIN':
            // Refresh user data when someone logs in
            setTimeout(() => refreshUserData(), 1000);
            break;
            
          case 'USER_LOGOUT':
            // Refresh user data when someone logs out
            setTimeout(() => refreshUserData(), 1000);
            break;
            
          case 'SUBMISSION_CREATED':
            // Update submission statistics
            loadSubmissionData();
            break;
        }
      });
    }

    // ============ AUTO REFRESH ============
    
    // Auto refresh user data every 30 seconds
    setInterval(() => {
      if (document.getElementById('user-sessions').classList.contains('active')) {
        refreshUserData();
      }
    }, 30000);

    // Auto refresh submission data every 60 seconds
    setInterval(() => {
      if (document.getElementById('data-monitoring').classList.contains('active')) {
        loadSubmissionData();
      }
    }, 60000);

    // ============ EVENT LISTENERS ============
    
    // Check auth before page unload
    window.addEventListener('beforeunload', function(e) {
      if (!AdminAuth.isLoggedIn()) {
        e.preventDefault();
        e.returnValue = '';
        return 'Session admin telah berakhir';
      }
    });

    // Handle page visibility change
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        // Page visible again, check session
        if (!AdminAuth.isLoggedIn()) {
          AdminAuth.logout();
        }
      }
    });

    // ============ STARTUP ============
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      initializeAdmin();
    });

    // Make AdminAuth available globally for debugging
    window.AdminAuth = AdminAuth;
    window.systemState = systemState;
  </script>
</body>
</html>
