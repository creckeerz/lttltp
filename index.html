<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Form Monitoring LTT & LTP</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/smartwizard@6/dist/css/smart_wizard_all.min.css">
  <style>
    .scrollable-table {
      overflow-x: auto;
      max-width: 100%;
    }

    /* Mencegah teks memanjang memecah baris */
    #historyTable th,
    #historyTable td {
      white-space: nowrap;
    }

    /* Kolom sticky untuk "Nama Penyuluh" (index ke-2) */
    #historyTable th.sticky-col-3 {
      position: sticky;
      left: 0;
      background: #2c3e50;
      color: white;
      z-index: 3;
    }

    #historyTable td.sticky-col-3 {
      position: sticky;
      left: 0;
      background: #ffffff;
      color: #000;
      z-index: 2;
    }

    /* Warna header umum */
    #historyTable th {
      background: #2c3e50;
      color: white;
    }

    /* Gaya umum */
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f6f9;
      padding: 20px;
      margin: 0;
    }

    .main-header {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 30px;
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 768px;
      margin: 0 auto 30px auto;
      position: relative;
    }

    .main-header h1 {
      font-size: 28px;
      margin: 0 0 15px 0;
      color: #2c3e50;
    }

    /* User info and logout button */
    .user-info {
      position: absolute;
      top: 15px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 14px;
      color: #7f8c8d;
    }

    .logout-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.3s ease;
    }

    .logout-btn:hover {
      background: #c0392b;
    }

    .session-info {
      font-size: 12px;
      color: #95a5a6;
    }

    .sub-headers {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .sub-header {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 16px;
      text-align: center;
      flex: 1;
      min-width: 200px;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
    }

    .sub-header.ltt {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
    }

    .sub-header.ltp {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
    }

    .sw-container {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 768px;
      margin: 0 auto 30px auto;
    }

    .sw-container label {
      font-weight: 600;
      color: #34495e;
      display: block;
      margin-top: 14px;
    }

    .sw-container input, .sw-container select {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 15px;
      box-sizing: border-box;
    }

    button.sw-btn {
      margin-top: 20px;
      padding: 10px 20px;
      background: #2ecc71;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }

    button.sw-btn:hover {
      background: #27ae60;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      border-radius: 10px;
      overflow: hidden;
      margin: 0 auto 50px auto;
      max-width: 768px;
    }

    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
      font-size: 14px;
    }

    th {
      background: #2c3e50;
      color: white;
    }

    .controls {
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
      max-width: 768px;
      margin-inline: auto;
    }

    .controls input[type="text"] {
      padding: 8px;
      width: 100%;
      max-width: 250px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .controls button {
      font-size: 14px;
      padding: 8px 16px;
    }

    /* Offline Status Indicator */
    .offline-status {
      position: fixed;
      top: 20px;
      left: 20px;
      background: #e74c3c;
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: none;
    }

    .offline-status.online {
      background: #2ecc71;
    }

    .offline-status.syncing {
      background: #f39c12;
    }

    /* Pending Submissions Counter */
    .pending-counter {
      position: fixed;
      top: 70px;
      left: 20px;
      background: #9b59b6;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      z-index: 1000;
      display: none;
    }

    /* Form auto-save indicator */
    .form-auto-save {
      background: #e8f5e8;
      border-left: 4px solid #2ecc71;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-size: 14px;
      display: none;
    }

    /* Auth protection overlay */
    .auth-protection {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      z-index: 10000;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .auth-loading {
      text-align: center;
      color: #2c3e50;
    }

    .auth-loading .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Session warning */
    .session-warning {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #f39c12;
      color: white;
      padding: 20px 30px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      z-index: 10001;
      text-align: center;
      display: none;
    }

    .session-warning button {
      background: white;
      color: #f39c12;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      margin: 0 5px;
      cursor: pointer;
      font-weight: 600;
    }

    /* Month lock warning */
    .month-lock-warning {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #e74c3c;
      color: white;
      padding: 25px 35px;
      border-radius: 12px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.3);
      z-index: 10002;
      text-align: center;
      display: none;
      max-width: 500px;
    }

    .month-lock-warning h3 {
      margin-bottom: 15px;
      font-size: 20px;
    }

    .month-lock-warning button {
      background: white;
      color: #e74c3c;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      margin-top: 15px;
      cursor: pointer;
      font-weight: 600;
    }

    /* Login form styles */
    .login-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      z-index: 20000;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .login-form {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .login-form h2 {
      color: #2c3e50;
      margin-bottom: 30px;
      font-size: 28px;
    }

    .login-form .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .login-form label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #34495e;
    }

    .login-form input,
    .login-form select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e8ed;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .login-form input:focus,
    .login-form select:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .login-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .login-btn:hover {
      transform: translateY(-2px);
    }

    .login-error {
      background: #e74c3c;
      color: white;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
    }

    .admin-link {
      margin-top: 20px;
      color: #7f8c8d;
      font-size: 12px;
    }

    .admin-link a {
      color: #3498db;
      text-decoration: none;
    }

    /* Admin broadcast message */
    .admin-message {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #9b59b6;
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      z-index: 10003;
      max-width: 350px;
      display: none;
    }

    .admin-message h4 {
      margin-bottom: 10px;
      font-size: 16px;
    }

    .admin-message .close-btn {
      position: absolute;
      top: 5px;
      right: 10px;
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Login Container -->
  <div id="loginContainer" class="login-container">
    <div class="login-form">
      <h2>🔐 Login Sistem</h2>
      <div id="loginError" class="login-error"></div>
      
      <form id="loginForm">
        <div class="form-group">
          <label>Kode Akses</label>
          <input type="text" id="accessCode" placeholder="Masukkan kode akses" required />
        </div>
        
        <div class="form-group">
          <label>Nama Penyuluh</label>
          <select id="penyuluhName" required>
            <option value="">-- Pilih Nama Penyuluh --</option>
            <option>A.PURNAMA PUTRA</option>
            <option>AAN PUJINURINSAN</option>
            <option>ABDUL RAHMAN</option>
            <option>AGUS SAIFUDDIN</option>
            <option>AGUSMANTO</option>
            <option>AHADI</option>
            <option>ALMIZAN</option>
            <option>ALWAN SASRUDIN</option>
            <option>ANDI</option>
            <option>ANDI WIHARDI</option>
            <option>ANDI WILLIAM</option>
            <option>ANTO SAPUTRA</option>
            <option>ARAMIYA</option>
            <option>BUDI SETIAWAN</option>
            <option>DARMA IRAWAN</option>
            <option>DARMADI</option>
            <option>DARUSSALAM</option>
            <option>DINO</option>
            <option>DIYANTO</option>
            <option>EDI WAHYUDI</option>
            <option>EDWARDI</option>
            <option>EKO SURYONO</option>
            <option>ELYA KANDAU</option>
            <option>EMELDA</option>
            <option>ESPAHANI</option>
            <option>FITRIANI</option>
            <option>FREEADI</option>
            <option>HENGKY KUSUMA INDRA</option>
            <option>HERY PRAMONO</option>
            <option>IBNU ROSIHAN</option>
            <option>IMANSYAH</option>
            <option>IRLAH</option>
            <option>IWAN APRIANTO</option>
            <option>JAKA SUBHAN</option>
            <option>JAWARI</option>
            <option>JAYA HARTO</option>
            <option>JUANDA</option>
            <option>JUANDI</option>
            <option>JUMIATI</option>
            <option>KAMRAN</option>
            <option>KARNILA</option>
            <option>K.BUDIMAN</option>
            <option>LILI SINTA RUSTIKA</option>
            <option>MARNI</option>
            <option>MUHAMMAD IRHAMSYAH</option>
            <option>MUHAMMAD SAHADI</option>
            <option>MULYADI</option>
            <option>MURNI HADI</option>
            <option>MURNIATI</option>
            <option>NAZRULLAH</option>
            <option>NEVI ARYATI</option>
            <option>NIRLAWATI</option>
            <option>NINING MUSWANI</option>
            <option>NOVI YANA</option>
            <option>NURLENA</option>
            <option>NURHAYATI</option>
            <option>NUR LAILA SARI</option>
            <option>RAKHMAD BURHAN</option>
            <option>RENA</option>
            <option>RIAN PRASOJO</option>
            <option>RIZA NOVINA</option>
            <option>ROMI</option>
            <option>RONA NURBAYA</option>
            <option>RUSDIANSYAH</option>
            <option>SAMTIDAR</option>
            <option>SAR'ANI</option>
            <option>SARTINI</option>
            <option>SAPTINO</option>
            <option>STEPHANUS PUJI SETIAWAN</option>
            <option>SUHAIMI</option>
            <option>SUDARTO</option>
            <option>SUMIATI</option>
            <option>SUPARJO</option>
            <option>SURIYANTO</option>
            <option>TAUPIT</option>
            <option>TEGUH PRIONO</option>
            <option>TULUS PRIADI</option>
            <option>U. NASHIRUDDIN</option>
            <option>VOLENDI</option>
            <option>WAHIDAH</option>
            <option>WINARDI</option>
            <option>WIWIT</option>
            <option>YANTI</option>
            <option>YENI DARMILA</option>
            <option>YUNIA</option>
            <option>YUSNANI</option>
            <option>ZULPIANA</option>
          </select>
        </div>
        
        <button type="submit" class="login-btn">🚀 Login</button>
      </form>
      
      <div class="admin-link">
        <a href="#" onclick="switchToAdminLogin()">Login sebagai Admin</a>
      </div>
    </div>
  </div>

  <!-- Auth Protection Overlay -->
  <div id="authProtection" class="auth-protection" style="display: none;">
    <div class="auth-loading">
      <div class="spinner"></div>
      <h3>Memverifikasi akses...</h3>
      <p>Mohon tunggu sebentar</p>
    </div>
  </div>

  <!-- Session Warning -->
  <div id="sessionWarning" class="session-warning">
    <h4>⚠️ Sesi Akan Berakhir</h4>
    <p>Sesi Anda akan berakhir dalam <span id="sessionCountdown">5</span> menit.</p>
    <button onclick="extendSession()">Perpanjang Sesi</button>
    <button onclick="logout()">Logout</button>
  </div>

  <!-- Month Lock Warning -->
  <div id="monthLockWarning" class="month-lock-warning">
    <h3>🔒 Bulan Terkunci</h3>
    <p id="monthLockMessage">Input untuk bulan ini telah dikunci oleh administrator.</p>
    <button onclick="hideMonthLockWarning()">Mengerti</button>
  </div>

  <!-- Admin Broadcast Message -->
  <div id="adminMessage" class="admin-message">
    <button class="close-btn" onclick="closeAdminMessage()">×</button>
    <h4>📢 Pesan Admin</h4>
    <p id="adminMessageText"></p>
  </div>

  <!-- Offline Status Indicators -->
  <div id="offlineStatus" class="offline-status">
    📡 Status Koneksi
  </div>
  
  <div id="pendingCounter" class="pending-counter">
    📤 <span id="pendingCount">0</span> data menunggu sinkronisasi
  </div>

  <!-- Main Header with Sub Headers -->
  <div class="main-header">
    <div class="user-info">
      <div class="session-info">
        <div>User: <span id="userCode">***</span></div>
        <div>Login: <span id="loginTime">***</span></div>
        <div>Sisa: <span id="timeRemaining">***</span></div>
      </div>
      <button class="logout-btn" onclick="logout()">🚪 Logout</button>
    </div>
    
    <h1>Form Monitoring LTT & LTP</h1>
    <p>Sistem Monitoring Luas Tambah Tanam dan Luas Tambah Panen</p>
    <div class="sub-headers">
      <div class="sub-header ltt">
        <strong>Luas Tambah Tanam (LTT)</strong><br>
        <small>Data Penanaman Jagung & Padi</small>
      </div>
      <div class="sub-header ltp">
        <strong>Luas Tambah Panen (LTP)</strong><br>
        <small>Data Panen Padi & Produktivitas</small>
      </div>
    </div>
  </div>

  <div class="sw-container">
    <!-- Auto-save indicator -->
    <div id="autoSaveIndicator" class="form-auto-save">
      💾 Data form disimpan otomatis setiap perubahan
    </div>

    <form id="monitoringForm">
      <div id="smartwizard">
        <ul class="nav">
          <li><a class="nav-link" href="#step-1">Step 1<br/><small>Info Dasar</small></a></li>
          <li><a class="nav-link" href="#step-2">Step 2<br/><small>Data LTT</small></a></li>
          <li><a class="nav-link" href="#step-3">Step 3<br/><small>Data LTP</small></a></li>
          <li><a class="nav-link" href="#step-4">Step 4<br/><small>Jagung & Submit</small></a></li>
        </ul>

       <div class="tab-content">
  <!-- STEP 1 -->
  <div id="step-1" class="tab-pane" role="tabpanel">
    <label>Timestamp <span style="color: red;">*</span></label>
    <input type="datetime-local" name="Timestamp" required />
    
    <label>Periode Monitoring <span style="color: red;">*</span></label>
    <select name="Periode Monitoring" required>
      <option value="">Pilih</option>
      <option value="Minggu ke 1">Minggu ke 1</option>
      <option value="Minggu ke 2">Minggu ke 2</option>
      <option value="Minggu ke 3">Minggu ke 3</option>
      <option value="Minggu ke 4">Minggu ke 4</option>
      <option value="Minggu ke 5">Minggu ke 5</option>
    </select>

    <label>Nama Penyuluh <span style="color: red;">*</span></label>
    <input type="text" name="nama" id="formPenyuluhName" readonly style="background: #f8f9fa;" required />

    <label>Kecamatan <span style="color: red;">*</span></label>
    <select name="Kecamatan" id="kecamatanSelect" required>
      <option value="">-- Pilih Kecamatan --</option>
    </select>
    
    <label>Desa <span style="color: red;">*</span></label>
    <select name="Desa" id="desaSelect" required>
      <option value="">-- Pilih Desa --</option>
    </select>
  </div>

  <!-- STEP 2 - DATA LTT -->
  <div id="step-2" class="tab-pane" role="tabpanel">
    <label>Luas Baku Sawah (LBS) <span style="color: red;">*</span></label>
    <input type="number" name="Luas Baku Sawah (LBS)" step="0.01" min="0" required />
    
    <label>Luas Tanam Tahun Sebelumnya (Ha) <span style="color: red;">*</span></label>
    <input type="number" name="Luas Tanam Tahun Sebelumnya (Ha)" step="0.01" min="0" required />
    
    <label>IP Existing <span style="color: red;">*</span></label>
    <input type="text" name="IP Existing" placeholder="Contoh: IP 200" required />
    
    <label>LTT Padi Reguler (Ha) <span style="color: red;">*</span></label>
    <input type="number" name="LTT Padi Reguler (Ha)" step="0.01" min="0" required />
    
    <label>LTT Padi Oplah (Ha) <span style="color: red;">*</span></label>
    <input type="number" name="LTT Padi Oplah (Ha)" step="0.01" min="0" required />
    
    <label>LTT Padi Irigasi Pompa (Ha) <span style="color: red;">*</span></label>
    <input type="number" name="LTT Padi Irigasi Pompa (Ha)" step="0.01" min="0" required />
    
    <label>LTT Padi Gogo / Lahan Kering (Ha) <span style="color: red;">*</span></label>
    <input type="number" name="LTT Padi Gogo / Lahan Kering" step="0.01" min="0" required />
  </div>

  <!-- STEP 3 - DATA LTP -->
  <div id="step-3" class="tab-pane" role="tabpanel">
    <label>LTP Padi Reguler (Ha) <span style="color: red;">*</span></label>
    <input type="number" name="LTP Padi Reguler (Ha)" step="0.01" min="0" required />
    
    <label>Produktivitas Padi Reguler (Ku/Ha) <span style="color: red;">*</span></label>
    <input type="number" name="Provitas Padi Reguler (Ku/Ha)" step="0.01" min="0" required />
    
    <label>LTP Padi Oplah (Ha) <span style="color: red;">*</span></label>
    <input type="number" name="LTP Padi Oplah (Ha)" step="0.01" min="0" required />
    
    <label>Produktivitas Padi Oplah (Ku/Ha) <span style="color: red;">*</span></label>
    <input type="number" name="Provitas Padi Oplah (Ku/Ha)" step="0.01" min="0" required />
    
    <label>LTP Padi Irigasi Pompa (Ha) <span style="color: red;">*</span></label>
    <input type="number" name="LTP Padi Irigasi Pompa (Ha)" step="0.01" min="0" required />
    
    <label>Produktivitas Padi Irigasi Pompa (Ku/Ha) <span style="color: red;">*</span></label>
    <input type="number" name="Provitas Padi irigasi Pompa (Ku/Ha)" step="0.01" min="0" required />
    
    <label>LTP Padi Gogo / Lahan Kering (Ha) <span style="color: red;">*</span></label>
    <input type="number" name="LTP Padi Gogo / Lahan Kering" step="0.01" min="0" required />
    
    <label>Produktivitas Padi Gogo (Ku/Ha) <span style="color: red;">*</span></label>
    <input type="number" name="Provitas Padi Gogo (Ku/Ha)" step="0.01" min="0" required />
  </div>

  <!-- STEP 4 - JAGUNG & SUBMIT -->
  <div id="step-4" class="tab-pane" role="tabpanel">
    <label>LTT Jagung (Ha) <span style="color: red;">*</span></label>
    <input type="number" name="LTT Jagung (Ha)" step="0.01" min="0" required />
    
    <label>LTP Jagung (Ha) <span style="color: red;">*</span></label>
    <input type="number" name="LTP Jagung (Ha)" step="0.01" min="0" required />
    
    <label>Produktivitas Jagung (Ku/Ha) <span style="color: red;">*</span></label>
    <input type="number" name="Provitas Jagung (Ku/Ha)" step="0.01" min="0" required />
    
    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #2ecc71;">
      <h4 style="color: #2c3e50; margin-bottom: 10px;">📋 Ringkasan Pengisian</h4>
      <p style="color: #7f8c8d; font-size: 14px; margin-bottom: 15px;">
        Pastikan semua data yang diisi sudah benar sebelum mengirim.
      </p>
      <div style="display: flex; gap: 10px; align-items: center;">
        <input type="checkbox" id="confirmData" required style="transform: scale(1.2);">
        <label for="confirmData" style="color: #34495e; font-weight: 600;">
          Saya telah memeriksa dan memastikan semua data sudah benar <span style="color: red;">*</span>
        </label>
      </div>
    </div>
    
    <button type="submit" style="
      width: 100%;
      margin-top: 20px;
      padding: 15px 20px;
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(46, 204, 113, 0.3)'" 
       onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
      ✅ Kirim Data Monitoring
    </button>
  </div>
</div>

  <!-- Table & Control -->
  <div class="controls">
    <input type="text" id="searchInput" placeholder="🔍 Cari di tabel...">
    <div>
      <button type="button" onclick="loadData()">🔄 Reload Data</button>
      <button type="button" onclick="exportTableToExcel()">📥 Export Excel</button>
      <button type="button" id="manualSyncBtn" onclick="manualSync()" style="display: none;">🔄 Sync Manual</button>
    </div>
  </div>

  <div class="table-wrapper scrollable-table">
    <table id="historyTable">
      <thead id="tableHead"><tr></tr></thead>
      <tbody></tbody>
    </table>
    <div class="pagination" id="pagination"></div>
  </div>

  <!-- Loading & Toast -->
  <div id="loadingOverlay" style="
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: 20px;
  ">
    ⏳ Mengirim data...
  </div>

  <div id="toast" style="
    display: none;
    position: fixed;
    bottom: 20px; left: 50%;
    transform: translateX(-50%);
    background: #2ecc71;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 16px;
    z-index: 10000;
  ">
    ✅ Data berhasil dikirim
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/smartwizard@6/dist/js/jquery.smartWizard.min.js"></script>
  
  <script>
    // ============ CONFIGURATION ============
    
    const CONFIG = {
      scriptURL: 'https://script.google.com/macros/s/AKfycbzH7ZFKlKjeFlVxvqYFwJVBNw98yYHtyFqquXcRo-gEqNDHtPM4SmQawYT_yPrZlW9g/exec',
      perPage: 5,
      sessionKey: 'ltt_user_session',
      adminSessionKey: 'ltt_admin_session'
    };

    // ============ GLOBAL VARIABLES ============
    
    let currentSession = null;
    let allData = [], originalData = [], currentPage = 1;
    let isOnline = navigator.onLine;
    let autoSaveTimeout = null;
    let sessionWarningInterval = null;
    let sessionCheckInterval = null;
    let timeRemainingInterval = null;

    // Header yang sesuai dengan urutan di spreadsheet
    const defaultHeaders = [
      "Timestamp", "Periode Monitoring", "Nama Penyuluh", "Kecamatan", "Desa",
      "LTT Padi Reguler (Ha)", "LTT Padi Oplah (Ha)", "LTT Padi Irigasi Pompa (Ha)",
      "LTP Padi Reguler (Ha)", "Provitas Padi Reguler (Ku/Ha)", "LTP Padi Oplah (Ha)",
      "Provitas Padi Oplah (Ku/Ha)", "LTP Padi Irigasi Pompa (Ha)", "Provitas Padi irigasi Pompa (Ku/Ha)",
      "LTT Padi Gogo / Lahan Kering", "LTP Padi Gogo / Lahan Kering", "LTT Jagung (Ha)",
      "LTP Jagung (Ha)", "Provitas Jagung (Ku/Ha)", "Luas Baku Sawah (LBS)",
      "IP Existing", "Luas Tanam Tahun Sebelumnya (Ha)", "Provitas Padi Gogo (Ku/Ha)"
    ];

    // ============ AUTHENTICATION SYSTEM ============
    
    const AuthSystem = {
      // Check if user is logged in
      isLoggedIn: function() {
        const session = localStorage.getItem(CONFIG.sessionKey);
        if (!session) return false;
        
        try {
          const sessionData = JSON.parse(session);
          return Date.now() < sessionData.expiresAt && sessionData.sessionId;
        } catch {
          return false;
        }
      },
      
      // Get current session
      getSession: function() {
        const session = localStorage.getItem(CONFIG.sessionKey);
        if (!session) return null;
        
        try {
          return JSON.parse(session);
        } catch {
          return null;
        }
      },
      
      // Save session
      saveSession: function(sessionData) {
        localStorage.setItem(CONFIG.sessionKey, JSON.stringify(sessionData));
        currentSession = sessionData;
      },
      
      // Clear session
      clearSession: function() {
        localStorage.removeItem(CONFIG.sessionKey);
        currentSession = null;
      },
      
      // Login user
      login: async function(accessCode, penyuluhName) {
        try {
          const formData = new FormData();
          formData.append('action', 'login');
          formData.append('access_code', accessCode);
          formData.append('penyuluh_name', penyuluhName);
          
          const response = await fetch(CONFIG.scriptURL, {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            this.saveSession(result.session);
            return { success: true, session: result.session };
          } else {
            return { success: false, error: result.error };
          }
        } catch (error) {
          console.error('Login error:', error);
          return { success: false, error: 'Koneksi bermasalah. Silakan coba lagi.' };
        }
      },
      
      // Logout user
      logout: async function() {
        const session = this.getSession();
        if (session) {
          try {
            const formData = new FormData();
            formData.append('action', 'logout');
            formData.append('session_id', session.sessionId);
            
            await fetch(CONFIG.scriptURL, {
              method: 'POST',
              body: formData
            });
          } catch (error) {
            console.log('Logout API call failed:', error);
          }
        }
        
        this.clearSession();
        this.showLogin();
      },
      
      // Validate session with server
      validateSession: async function() {
        const session = this.getSession();
        if (!session) return false;
        
        try {
          const formData = new FormData();
          formData.append('action', 'validate_session');
          formData.append('session_id', session.sessionId);
          
          const response = await fetch(CONFIG.scriptURL, {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success && result.session) {
            // Update local session with server data
            const updatedSession = { ...session, ...result.session };
            this.saveSession(updatedSession);
            return true;
          } else {
            this.clearSession();
            return false;
          }
        } catch (error) {
          console.log('Session validation failed:', error);
          return false;
        }
      },
      
      // Extend session
      extendSession: async function() {
        const session = this.getSession();
        if (!session) return false;
        
        try {
          const formData = new FormData();
          formData.append('action', 'extend_session');
          formData.append('session_id', session.sessionId);
          
          const response = await fetch(CONFIG.scriptURL, {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            session.expiresAt = result.newExpiresAt;
            this.saveSession(session);
            hideSessionWarning();
            showToast('✅ Sesi berhasil diperpanjang', true);
            return true;
          }
        } catch (error) {
          console.log('Extend session failed:', error);
        }
        
        return false;
      },
      
      // Show login form
      showLogin: function() {
        document.getElementById('loginContainer').style.display = 'flex';
        document.getElementById('authProtection').style.display = 'none';
        
        // Clear intervals
        if (sessionCheckInterval) clearInterval(sessionCheckInterval);
        if (sessionWarningInterval) clearInterval(sessionWarningInterval);
        if (timeRemainingInterval) clearInterval(timeRemainingInterval);
      },
      
      // Hide login form
      hideLogin: function() {
        document.getElementById('loginContainer').style.display = 'none';
      }
    };

    // ============ MONTH LOCK SYSTEM ============
    
    const MonthLockSystem = {
      // Check if month is locked
      checkMonthLock: async function(timestamp) {
        try {
          const response = await fetch(CONFIG.scriptURL + '?config=1');
          const config = await response.json();
          
          if (config.monthLock && config.monthLock.enabled) {
            const inputDate = new Date(timestamp);
            const inputMonth = inputDate.getMonth() + 1;
            const inputYear = inputDate.getFullYear();
            
            if (inputMonth == config.monthLock.month && inputYear == config.monthLock.year) {
              return {
                locked: true,
                message: config.monthLock.message || `Input untuk bulan ${inputMonth}/${inputYear} telah dikunci oleh administrator.`
              };
            }
          }
          
          return { locked: false };
        } catch (error) {
          console.log('Month lock check failed:', error);
          return { locked: false };
        }
      },
      
      // Show month lock warning
      showWarning: function(message) {
        document.getElementById('monthLockMessage').textContent = message;
        document.getElementById('monthLockWarning').style.display = 'block';
      }
    };

    // ============ ADMIN MESSAGE SYSTEM ============
    
    const AdminMessageSystem = {
      // Check for admin messages
      checkAdminMessages: function() {
        const broadcast = localStorage.getItem('ltt_admin_broadcast');
        if (broadcast) {
          try {
            const message = JSON.parse(broadcast);
            const lastShown = localStorage.getItem('ltt_last_admin_message_id');
            
            if (message.id.toString() !== lastShown) {
              this.showMessage(message.message);
              localStorage.setItem('ltt_last_admin_message_id', message.id.toString());
            }
          } catch (e) {
            console.log('Error parsing admin message:', e);
          }
        }
      },
      
      // Show admin message
      showMessage: function(text) {
        document.getElementById('adminMessageText').textContent = text;
        document.getElementById('adminMessage').style.display = 'block';
        
        // Auto hide after 10 seconds
        setTimeout(() => {
          this.hideMessage();
        }, 10000);
      },
      
      // Hide admin message
      hideMessage: function() {
        document.getElementById('adminMessage').style.display = 'none';
      }
    };

    // ============ SESSION MONITORING ============
    
    function startSessionMonitoring() {
      // Check session every 30 seconds
      sessionCheckInterval = setInterval(async () => {
        const isValid = await AuthSystem.validateSession();
        if (!isValid) {
          showToast('❌ Sesi telah berakhir. Silakan login kembali.', false);
          setTimeout(() => AuthSystem.logout(), 2000);
          return;
        }
        
        const session = AuthSystem.getSession();
        if (session) {
          const timeLeft = session.expiresAt - Date.now();
          const warningTime = 5 * 60 * 1000; // 5 menit
          
          // Show warning jika sisa waktu <= 5 menit
          if (timeLeft <= warningTime && timeLeft > 0) {
            showSessionWarning(Math.ceil(timeLeft / 60000));
          }
        }
      }, 30000);
      
      // Update time remaining display every minute
      timeRemainingInterval = setInterval(() => {
        updateTimeRemainingDisplay();
      }, 60000);
    }

    function showSessionWarning(minutesLeft) {
      const warningEl = document.getElementById('sessionWarning');
      const countdownEl = document.getElementById('sessionCountdown');
      
      countdownEl.textContent = minutesLeft;
      warningEl.style.display = 'block';
      
      // Update countdown setiap menit
      if (!sessionWarningInterval) {
        sessionWarningInterval = setInterval(() => {
          const session = AuthSystem.getSession();
          if (!session) {
            clearInterval(sessionWarningInterval);
            sessionWarningInterval = null;
            return;
          }
          
          const timeLeft = session.expiresAt - Date.now();
          const minutes = Math.ceil(timeLeft / 60000);
          
          if (minutes <= 0) {
            clearInterval(sessionWarningInterval);
            sessionWarningInterval = null;
            AuthSystem.logout();
            return;
          }
          
          countdownEl.textContent = minutes;
        }, 60000);
      }
    }

    function hideSessionWarning() {
      document.getElementById('sessionWarning').style.display = 'none';
      if (sessionWarningInterval) {
        clearInterval(sessionWarningInterval);
        sessionWarningInterval = null;
      }
    }

    function updateTimeRemainingDisplay() {
      const session = AuthSystem.getSession();
      if (session) {
        const timeLeft = session.expiresAt - Date.now();
        const hours = Math.floor(timeLeft / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        
        if (timeLeft > 0) {
          document.getElementById('timeRemaining').textContent = `${hours}j ${minutes}m`;
        } else {
          document.getElementById('timeRemaining').textContent = 'Expired';
        }
      }
    }

    function updateUserInfo() {
      const session = AuthSystem.getSession();
      if (session) {
        document.getElementById('userCode').textContent = session.userCode;
        document.getElementById('loginTime').textContent = new Date(session.loginTime).toLocaleTimeString();
        document.getElementById('formPenyuluhName').value = session.penyuluhName;
        updateTimeRemainingDisplay();
      }
    }

    // ============ LOGIN FORM HANDLING ============
    
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const accessCode = document.getElementById('accessCode').value;
      const penyuluhName = document.getElementById('penyuluhName').value;
      const errorEl = document.getElementById('loginError');
      
      if (!accessCode || !penyuluhName) {
        errorEl.textContent = 'Semua field harus diisi';
        errorEl.style.display = 'block';
        return;
      }
      
      // Show loading
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.textContent = '⏳ Memproses...';
      submitBtn.disabled = true;
      
      // Attempt login
      const result = await AuthSystem.login(accessCode, penyuluhName);
      
      if (result.success) {
        AuthSystem.hideLogin();
        initializeApp();
        showToast('✅ Login berhasil!', true);
      } else {
        errorEl.textContent = result.error;
        errorEl.style.display = 'block';
      }
      
      // Reset button
      submitBtn.textContent = '🚀 Login';
      submitBtn.disabled = false;
    });

    function switchToAdminLogin() {
      window.location.href = 'admin.html';
    }

    // ============ OFFLINE FUNCTIONALITY ============
    
    // Memonitor status koneksi
    function updateConnectionStatus() {
      const statusEl = document.getElementById('offlineStatus');
      
      if (navigator.onLine) {
        statusEl.textContent = '🟢 Online';
        statusEl.className = 'offline-status online';
        statusEl.style.display = 'block';
        
        // Auto sync saat kembali online
        if (!isOnline) {
          syncPendingSubmissions();
        }
        isOnline = true;
        
        // Hide status setelah 3 detik jika online
        setTimeout(() => {
          if (navigator.onLine && getPendingSubmissions().length === 0) {
            statusEl.style.display = 'none';
          }
        }, 3000);
      } else {
        statusEl.textContent = '🔴 Offline - Data akan disimpan lokal';
        statusEl.className = 'offline-status';
        statusEl.style.display = 'block';
        isOnline = false;
      }
      
      updatePendingCounter();
    }

    // Update counter pending submissions
    function updatePendingCounter() {
      const pendingSubmissions = getPendingSubmissions();
      const pendingEl = document.getElementById('pendingCounter');
      const countEl = document.getElementById('pendingCount');
      const syncBtn = document.getElementById('manualSyncBtn');
      
      if (pendingSubmissions.length > 0) {
        countEl.textContent = pendingSubmissions.length;
        pendingEl.style.display = 'block';
        if (syncBtn) syncBtn.style.display = 'inline-block';
      } else {
        pendingEl.style.display = 'none';
        if (syncBtn) syncBtn.style.display = 'none';
      }
    }

    // Manual sync function
    function manualSync() {
      if (navigator.onLine) {
        syncPendingSubmissions();
      } else {
        showToast('❌ Tidak ada koneksi internet', false);
      }
    }

    // Simpan form data ke localStorage
    function saveFormDataLocally(formData) {
      const dataObj = {};
      for (let [key, value] of formData.entries()) {
        dataObj[key] = value;
      }
      
      dataObj._saveTime = Date.now();
      dataObj._id = 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      
      localStorage.setItem('ltt_form_data', JSON.stringify(dataObj));
      return dataObj;
    }

    // Load form data dari localStorage
    function loadFormDataLocally() {
      return JSON.parse(localStorage.getItem('ltt_form_data') || '{}');
    }

    // Auto-save form setiap input berubah
    function setupAutoSave() {
      const form = document.getElementById('monitoringForm');
      const inputs = form.querySelectorAll('input, select');
      
      inputs.forEach(input => {
        input.addEventListener('input', () => {
          clearTimeout(autoSaveTimeout);
          autoSaveTimeout = setTimeout(() => {
            const formData = new FormData(form);
            saveFormDataLocally(formData);
            showAutoSaveIndicator();
          }, 1000);
        });
      });
    }

    // Tampilkan indikator auto-save
    function showAutoSaveIndicator() {
      const indicator = document.getElementById('autoSaveIndicator');
      indicator.style.display = 'block';
      indicator.innerHTML = '💾 Data tersimpan otomatis pada: ' + new Date().toLocaleTimeString();
      
      setTimeout(() => {
        indicator.style.display = 'none';
      }, 3000);
    }

    // Simpan submission ke queue offline
    function saveSubmissionToQueue(formData) {
      const pendingSubmissions = getPendingSubmissions();
      
      const dataObj = {};
      for (let [key, value] of formData.entries()) {
        dataObj[key] = value;
      }
      
      dataObj._submissionTime = Date.now();
      dataObj._id = 'pending_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      
      pendingSubmissions.push(dataObj);
      localStorage.setItem('ltt_pending_submissions', JSON.stringify(pendingSubmissions));
      
      updatePendingCounter();
      return dataObj._id;
    }

    // Get pending submissions
    function getPendingSubmissions() {
      return JSON.parse(localStorage.getItem('ltt_pending_submissions') || '[]');
    }

    // Sinkronisasi pending submissions
    async function syncPendingSubmissions() {
      const pendingSubmissions = getPendingSubmissions();
      if (pendingSubmissions.length === 0) return;
      
      const statusEl = document.getElementById('offlineStatus');
      statusEl.textContent = '🔄 Menyinkronkan ' + pendingSubmissions.length + ' data...';
      statusEl.className = 'offline-status syncing';
      statusEl.style.display = 'block';
      
      let successCount = 0;
      const totalCount = pendingSubmissions.length;
      
      for (let i = 0; i < pendingSubmissions.length; i++) {
        const submission = pendingSubmissions[i];
        const formData = new FormData();
        
        // Add session info
        const session = AuthSystem.getSession();
        if (session) {
          formData.append('session_id', session.sessionId);
        }
        
        for (let key in submission) {
          if (!key.startsWith('_')) {
            formData.append(key, submission[key]);
          }
        }
        
        try {
          const response = await fetch(CONFIG.scriptURL, {
            method: 'POST',
            body: formData
          });
          
          const result = await response.json();
          
          if (result.success) {
            successCount++;
            pendingSubmissions.splice(i, 1);
            i--;
            localStorage.setItem('ltt_pending_submissions', JSON.stringify(pendingSubmissions));
            updatePendingCounter();
          }
        } catch (error) {
          console.log('Sync failed for submission:', submission._id);
        }
        
        statusEl.textContent = `🔄 Sinkronisasi ${successCount}/${totalCount}...`;
      }
      
      if (successCount > 0) {
        showToast(`✅ ${successCount} data berhasil disinkronkan`, true);
        loadData();
      }
      
      if (pendingSubmissions.length === 0) {
        statusEl.textContent = '🟢 Semua data tersinkronkan';
        setTimeout(() => {
          if (navigator.onLine) {
            statusEl.style.display = 'none';
          }
        }, 3000);
      }
      
      updatePendingCounter();
    }

    // Load saved form data saat halaman dimuat
    function restoreFormData() {
      const savedData = loadFormDataLocally();
      if (Object.keys(savedData).length === 0) return;
      
      const form = document.getElementById('monitoringForm');
      
      for (let key in savedData) {
        if (!key.startsWith('_')) {
          const input = form.querySelector(`[name="${key}"]`);
          if (input && input.id !== 'formPenyuluhName') { // Don't restore readonly field
            input.value = savedData[key];
            
            if (input.tagName === 'SELECT') {
              input.dispatchEvent(new Event('change'));
            }
          }
        }
      }
      
      showToast('📋 Data form sebelumnya telah dipulihkan', true);
    }

    // Event listeners untuk monitoring koneksi
    window.addEventListener('online', updateConnectionStatus);
    window.addEventListener('offline', updateConnectionStatus);

    // ============ TABLE FUNCTIONALITY ============

    function renderTablePage(page) {
      const tableHead = document.getElementById("tableHead");
      const tableBody = document.querySelector("#historyTable tbody");
      currentPage = page;
      tableBody.innerHTML = '';
      
      // Buat header dengan kolom ke-3 sticky
      tableHead.innerHTML = '<tr>' + defaultHeaders.map((h, i) => 
        `<th class="${i === 2 ? 'sticky-col-3' : ''}">${h}</th>`
      ).join('') + '</tr>';

      const start = (page - 1) * CONFIG.perPage;
      const end = start + CONFIG.perPage;
      const pageData = allData.slice(start, end);

      // Buat baris data
      pageData.forEach(row => {
        const tr = document.createElement("tr");
        row.forEach((cell, i) => {
          const td = document.createElement("td");
          if (i === 2) td.classList.add("sticky-col-3");
          td.textContent = cell;
          tr.appendChild(td);
        });
        tableBody.appendChild(tr);
      });

      // Pagination
      const pagination = document.getElementById("pagination");
      pagination.innerHTML = '';
      const totalPages = Math.ceil(allData.length / CONFIG.perPage);
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        if (i === page) btn.classList.add("active");
        btn.onclick = () => renderTablePage(i);
        pagination.appendChild(btn);
      }
    }

    function loadData() {
      // Check auth before loading data
      if (!AuthSystem.isLoggedIn()) {
        AuthSystem.logout();
        return;
      }

      fetch(CONFIG.scriptURL + '?read=1')
        .then(res => res.json())
        .then(data => {
          originalData = data.slice(1).reverse();
          allData = [...originalData];
          renderTablePage(1);
        })
        .catch(error => {
          console.log('Error loading data:', error);
          showToast('⚠️ Gagal memuat data dari server', false);
        });
    }

    function exportTableToExcel(filename = 'data_ltt_ltp.xls') {
      // Check auth before export
      if (!AuthSystem.isLoggedIn()) {
        AuthSystem.logout();
        return;
      }

      const table = document.getElementById("historyTable");
      const html = table.outerHTML;
      const url = 'data:application/vnd.ms-excel,' + encodeURIComponent(html);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
    }

    function showLoading() {
      document.getElementById("loadingOverlay").style.display = "flex";
    }

    function hideLoading() {
      document.getElementById("loadingOverlay").style.display = "none";
    }

    function showToast(message, success = true) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.style.background = success ? "#2ecc71" : "#e74c3c";
      toast.style.display = "block";
      setTimeout(() => {
        toast.style.display = "none";
      }, 3000);
    }

    // ============ FORM SUBMISSION ============

    // Form submission dengan offline support dan auth check
    document.getElementById("monitoringForm").addEventListener('submit', async e => {
      e.preventDefault();
      
      // Check auth before submit
      if (!AuthSystem.isLoggedIn()) {
        AuthSystem.logout();
        return;
      }

      const form = e.target;
      const submitButton = form.querySelector("button[type='submit']");
      const formData = new FormData(form);

      // Format timestamp
      const rawTimestamp = formData.get("Timestamp");
      if (rawTimestamp) {
        const dt = new Date(rawTimestamp);
        const formatted = `${dt.getMonth() + 1}/${dt.getDate()}/${dt.getFullYear()} ${String(dt.getHours()).padStart(2, '0')}:${String(dt.getMinutes()).padStart(2, '0')}:00`;
        formData.set("Timestamp", formatted);
        
        // Check month lock
        const lockCheck = await MonthLockSystem.checkMonthLock(rawTimestamp);
        if (lockCheck.locked) {
          MonthLockSystem.showWarning(lockCheck.message);
          return;
        }
      }

      // Add session info
      const session = AuthSystem.getSession();
      if (session) {
        formData.append('session_id', session.sessionId);
      }

      // Disable submit button
      submitButton.disabled = true;
      
      if (!navigator.onLine) {
        // Offline: simpan ke queue
        const submissionId = saveSubmissionToQueue(formData);
        showToast("📱 Offline: Data disimpan lokal dan akan dikirim otomatis saat online", true);
        form.reset();
        localStorage.removeItem('ltt_form_data');
        updateUserInfo(); // Restore user info after form reset
        submitButton.disabled = false;
        return;
      }

      // Online: coba kirim langsung
      showLoading();
      
      try {
        const response = await fetch(CONFIG.scriptURL, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
          showToast("✅ Data berhasil dikirim", true);
          form.reset();
          localStorage.removeItem('ltt_form_data');
          updateUserInfo(); // Restore user info after form reset
          loadData();
          document.querySelector(".table-wrapper").scrollIntoView({ behavior: 'smooth' });
        } else {
          throw new Error(result.error || 'Server error');
        }
      } catch (error) {
        // Jika gagal kirim online, simpan ke queue offline
        const submissionId = saveSubmissionToQueue(formData);
        showToast("⚠️ Koneksi bermasalah. Data disimpan lokal dan akan dikirim otomatis saat koneksi stabil", false);
        form.reset();
        localStorage.removeItem('ltt_form_data');
        updateUserInfo(); // Restore user info after form reset
      } finally {
        hideLoading();
        submitButton.disabled = false;
      }
    });

    // Search filter
    document.getElementById("searchInput").addEventListener("input", function () {
      const keyword = this.value.toLowerCase();
      allData = originalData.filter(row => row.join(' ').toLowerCase().includes(keyword));
      renderTablePage(1);
    });

    // ============ KECAMATAN & DESA DATA ============

    // Data kecamatan dan desa
    const desaPerKecamatan = {
      "Selakau": ["Bentunai", "Gayung Bersambut", "Kuala", "Pangkalan Bemban", "Parit Baru (Selakau)", "Parit Kongsi", "Semelagi Besar", "Sungai Daun", "Sungai Nyirih (Selakau)", "Sungai Rusa", "Twi Mentibar"],
      "Selakau Timur": ["Gelik", "Seranggam", "Selakau Tua", "Buduk Sempadang"],
      "Salatiga": ["Sungai Toman", "Serumpun", "Serunai", "Salatiga", "Parit Baru (Salatiga)"],
      "Pemangkat": ["Gugah Sejahtera", "Harapan", "Jelutung", "Lonam", "Pemangkat Kota", "Penjajab", "Perapakan", "Sebatuan"],
      "Semparuk": ["Seburing", "Semparuk", "Singaraya", "Sepinggan", "Sepadu (Semparuk)"],
      "Tebas": ["Sejiram", "Batu Makjage", "Bekut", "Bukit Sigoler", "Dungun Perapakan", "Makrampai", "Maktangguk", "Maribas", "Matang Labong", "Mekar Sekuntum", "Mensere", "Pangkalan Kongsi", "Pusaka", "Seberkat", "Segarau Parit", "Segedong", "Sempalai", "Seret Ayon", "Tebas Kuala", "Tebas Sungai", "Sungai Kelambu", "Serindang", "Serumpun Buluh"],
      "Tekarang": ["Cepala", "Matang Segarau", "Merubung", "Rambayan", "Tekarang", "Sempadian", "Sari Makmur"],
      "Jawai": ["Bakau", "Dungun Laut", "Lambau", "Mutus Darussalam", "Parit Setia", "Pelimpaan", "Sarang Burung Kuala", "Sarang Burung Kolam", "Sarang Burung Danau", "Sarang Burung Usrat", "Sentebang", "Sungai Nilam", "Sungai Nyirih (Jawai)"],
      "Jawai Selatan": ["Jawai Laut", "Jelu Air", "Matang Terap", "Sabaran", "Sarilaba A", "Sarilaba B", "Semperiuk A", "Semperiuk B", "Suah Api"],
      "Sebawi": ["Sebangun", "Sebawi", "Semanjang", "Sempalai Sebedang", "Sepuk Tanjung", "Tebing Batu", "Tempatan"],
      "Sambas": ["Dalam Kaum", "Durian", "Gapura", "Jagur", "Kartiasa", "Lorong", "Lubuk Dagang", "Lumbang", "Pasar Melayu", "Pendawan", "Saing Rambi", "Sebayan", "Semangau", "Sumber Harapan", "Sungai Rambah", "Tanjung Bugis", "Tanjung Mekar", "Tumuk Manggis"],
      "Subah": ["Balai Gemuruh", "Sungai Sapak", "Sabung", "Madak", "Tebuah Elok", "Bukit Mulya", "Sungai Deden", "Sempurna", "Mukti Raharja", "Mensade", "Arga Pura", "Sapak Hulu Trans", "Karaban Jaya"],
      "Sejangkung": ["Parit Raja", "Penakalan", "Perigi Landu", "Perigi Limus", "Piantus", "Sekuduk", "Semanga", "Sendoyan", "Senujuh", "Sepantai", "Setalik", "Sulung"],
      "Sajad": ["Jirak", "Tengguli", "Mekar Jaya", "Beringin"],
      "Galing": ["Galing", "Ratu Sepudak", "Sagu", "Sungai Palah", "Tempapan Kuala", "Tempapan Hulu", "Tri Kembang", "Sijang", "Teluk Pandan", "Tri Gadu"],
      "Sajingan Besar": ["Kaliau", "Sebunga", "Santaban", "Sanatab", "Sungai Bening"],
      "Teluk Keramat": ["Sungai Kumpai", "Sekura", "Tri Mandayan", "Pedada", "Lela", "Puringan", "Berlimang", "Sungai Baru", "Sengawang", "Teluk Kaseh", "Sepadu (Teluk Keramat)", "Tambatan", "Kubangga", "Sungai Serabek", "Sayang Sedayu", "Pipit Teja", "Matang Segantar", "Mulia", "Teluk Kembang", "Samustida", "Tanjung Kerucut", "Sebagu", "Mekar Sekuntum", "Kuala Pangkalan Keramat", "Sabing"],
      "Tangaran": ["Arung Medang", "Arung Parak", "Merabuan", "Merpati", "Pancur", "Semata", "Simpang Empat", "Tangaran"],
      "Paloh": ["Kalimantan", "Matang Danau", "Tanah Hitam", "Malek", "Nibung", "Sebubus", "Temajuk", "Mentibar"]
    };

    const kecamatanSelect = document.getElementById("kecamatanSelect");
    const desaSelect = document.getElementById("desaSelect");

    // Populate kecamatan options
    function populateKecamatan() {
      kecamatanSelect.innerHTML = '<option value="">-- Pilih Kecamatan --</option>';
      for (let kecamatan in desaPerKecamatan) {
        const option = document.createElement("option");
        option.value = kecamatan;
        option.textContent = kecamatan;
        kecamatanSelect.appendChild(option);
      }
    }

    // Update desa options based on selected kecamatan
    kecamatanSelect.addEventListener("change", function () {
      const desaList = desaPerKecamatan[this.value] || [];
      desaSelect.innerHTML = '<option value="">-- Pilih Desa --</option>';
      desaList.forEach(desa => {
        const option = document.createElement("option");
        option.value = desa;
        option.textContent = desa;
        desaSelect.appendChild(option);
      });
    });

    // ============ BROADCAST CHANNEL COMMUNICATION ============
    
    // Listen for admin updates
    if (typeof BroadcastChannel !== 'undefined') {
      const channel = new BroadcastChannel('ltt_admin_updates');
      
      channel.addEventListener('message', (event) => {
        const { type, data } = event.data;
        
        switch (type) {
          case 'FORCE_LOGOUT':
            if (currentSession && currentSession.userCode === data.userId) {
              showToast('❌ Anda telah di-logout oleh administrator', false);
              setTimeout(() => AuthSystem.logout(), 2000);
            }
            break;
            
          case 'FORCE_LOGOUT_ALL':
            showToast('❌ Semua user telah di-logout oleh administrator', false);
            setTimeout(() => AuthSystem.logout(), 2000);
            break;
            
          case 'MONTH_LOCK_UPDATE':
            // Month lock settings updated
            break;
            
          case 'SESSION_SETTINGS_UPDATE':
            // Session settings updated
            break;
            
          case 'ADMIN_MESSAGE':
            AdminMessageSystem.showMessage(data.message);
            break;
        }
      });
    }

    // ============ UTILITY FUNCTIONS ============
    
    // Global functions for UI interactions
    function extendSession() {
      AuthSystem.extendSession();
    }

    function logout() {
      if (confirm('Apakah Anda yakin ingin logout?')) {
        AuthSystem.logout();
      }
    }

    function hideMonthLockWarning() {
      document.getElementById('monthLockWarning').style.display = 'none';
    }

    function closeAdminMessage() {
      AdminMessageSystem.hideMessage();
    }

    // ============ INITIALIZATION ============

    // Initialize app setelah login berhasil
    function initializeApp() {
      console.log('Initializing app...');
      
      // Update user info
      updateUserInfo();
      
      // Initialize components
      populateKecamatan();
      loadData();
      
      // Setup offline functionality
      updateConnectionStatus();
      setupAutoSave();
      
      // Start session monitoring
      startSessionMonitoring();
      
      // Check for admin messages
      AdminMessageSystem.checkAdminMessages();
      
      // Restore form data jika ada
      setTimeout(() => {
        restoreFormData();
      }, 1000);
      
      // Auto-sync setiap 30 detik jika online
      setInterval(() => {
        if (navigator.onLine && getPendingSubmissions().length > 0) {
          syncPendingSubmissions();
        }
      }, 30000);
      
      // Check admin messages every 2 minutes
      setInterval(() => {
        AdminMessageSystem.checkAdminMessages();
      }, 120000);
      
      console.log('App initialized successfully');
    }

    // Init Smart Wizard dengan error handling
    function initSmartWizard() {
      try {
        if (typeof $ !== 'undefined' && $.fn && $.fn.smartWizard) {
          $('#smartwizard').smartWizard({
            theme: 'dots',
            autoAdjustHeight: true,
            toolbarSettings: {
              toolbarPosition: 'bottom',
              showNextButton: true,
              showPreviousButton: true
            }
          });
          console.log('SmartWizard initialized successfully');
        } else {
          console.log('SmartWizard not available, form will work without step navigation');
          // SmartWizard tidak tersedia, tapi form tetap bisa digunakan
          document.querySelectorAll('.tab-pane').forEach((pane, index) => {
            if (index === 0) pane.style.display = 'block';
            else pane.style.display = 'none';
          });
        }
      } catch (error) {
        console.log('SmartWizard initialization failed:', error);
        // Fallback: tampilkan semua step
        document.querySelectorAll('.tab-pane').forEach(pane => {
          pane.style.display = 'block';
        });
      }
    }

    // Check authentication status saat halaman dimuat
    function checkInitialAuth() {
      if (AuthSystem.isLoggedIn()) {
        // User sudah login, validate session dengan server
        AuthSystem.validateSession().then(isValid => {
          if (isValid) {
            AuthSystem.hideLogin();
            initializeApp();
          } else {
            AuthSystem.showLogin();
          }
        });
      } else {
        AuthSystem.showLogin();
      }
    }

    // ============ STARTUP SEQUENCE ============
    
    // jQuery ready dengan fallback
    $(document).ready(function () {
      initSmartWizard();
      checkInitialAuth();
    });

    // Fallback jika jQuery tidak ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
          if (typeof $ === 'undefined') {
            console.log('jQuery not available, initializing without SmartWizard');
            checkInitialAuth();
          }
        }, 1000);
      });
    } else {
      setTimeout(() => {
        if (typeof $ === 'undefined') {
          console.log('jQuery not available, initializing without SmartWizard');
          checkInitialAuth();
        }
      }, 1000);
    }

    // Handle page visibility change (untuk session monitoring)
    document.addEventListener('visibilitychange', function() {
      if (!document.hidden) {
        // Page visible again, check session
        if (AuthSystem.isLoggedIn()) {
          AuthSystem.validateSession().then(isValid => {
            if (!isValid) {
              AuthSystem.logout();
            }
          });
        }
      }
    });

    // Handle beforeunload (warn about unsaved data)
    window.addEventListener('beforeunload', function(e) {
      const formData = loadFormDataLocally();
      if (Object.keys(formData).length > 0) {
        e.preventDefault();
        e.returnValue = '';
        return 'Ada data form yang belum tersimpan. Yakin ingin meninggalkan halaman?';
      }
    });

    // Cleanup intervals saat page unload
    window.addEventListener('unload', function() {
      if (sessionCheckInterval) {
        clearInterval(sessionCheckInterval);
      }
      if (sessionWarningInterval) {
        clearInterval(sessionWarningInterval);
      }
      if (timeRemainingInterval) {
        clearInterval(timeRemainingInterval);
      }
    });

    // Make objects available globally untuk debugging
    window.AuthSystem = AuthSystem;
    window.MonthLockSystem = MonthLockSystem;
    window.AdminMessageSystem = AdminMessageSystem;
  </script>
</body>
</html>
